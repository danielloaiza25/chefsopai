<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chef Ops AI - Restaurant Intelligence Platform</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #141419;
      --bg-tertiary: #1a1a24;
      --accent-red: #ff4757;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-orange: #f59e0b;
      --accent-cyan: #06b6d4;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --border-color: #2a2a35;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
      line-height: 1.6;
    }

    #root {
      min-height: 100vh;
      position: relative;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border-color);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent-red), #e84118);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
    }

    .header-info h1 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .header-info p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent-red);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #e84118;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
    }

    .btn-danger {
      background: rgba(255, 71, 87, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.35);
    }
    .btn-danger:hover {
      background: rgba(255, 71, 87, 0.22);
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn-warning {
      background: var(--accent-orange);
      color: white;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-red);
      box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    }

    .file-upload {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-tertiary);
    }

    .file-upload:hover {
      border-color: var(--accent-red);
      background: var(--bg-secondary);
    }

    .file-upload.drag-over {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }

    .file-upload input {
      display: none;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .upload-text {
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .data-preview {
      margin-top: 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow: auto;
    }

    .preview-table {
      width: 100%;
      font-size: 12px;
    }

    .preview-table th,
    .preview-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .preview-table th {
      color: var(--text-secondary);
      font-weight: 600;
    }

    .alert-banner {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
      border: 1px solid var(--accent-blue);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .alert-text h3 {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .alert-text p {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .alert-actions {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-color), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: var(--accent-color);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: var(--accent-green);
    }

    .stat-change.negative {
      color: var(--accent-red);
    }

    .predictions-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
    }

    .section-subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 4px;
    }

    .prediction-main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .prediction-metric {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 24px;
    }

    .metric-label {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .metric-value {
      font-size: 56px;
      font-weight: 900;
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 8px;
    }

    .metric-range {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .confidence-badge {
      display: inline-block;
      padding: 6px 14px;
      background: rgba(6, 182, 212, 0.2);
      color: var(--accent-cyan);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 12px;
    }

    .confidence-badge.low {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-orange);
    }

    .variance-text {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .prediction-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .detail-item {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 20px;
    }

    .detail-label {
      color: var(--text-secondary);
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .detail-value {
      font-size: 18px;
      font-weight: 700;
    }

    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .action-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 30px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }

    .action-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.05), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .action-card:hover::after {
      opacity: 1;
    }

    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .action-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent-red), #e84118);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(255, 71, 87, 0.3);
    }

    .action-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .action-description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .action-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--accent-cyan);
      font-size: 13px;
      font-weight: 600;
    }

    .critical-alerts {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .alert-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 4px solid var(--alert-color);
      transition: all 0.3s;
    }

    .alert-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .alert-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .alert-icon-wrapper {
      width: 48px;
      height: 48px;
      background: rgba(255, 71, 87, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .alert-details h4 {
      font-size: 16px;
      margin-bottom: 6px;
    }

    .alert-details p {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .alert-action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 14px;
    }

    .tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--accent-red);
      color: white;
    }

    .inventory-table {
      width: 100%;
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
    }

    .inventory-table thead {
      background: var(--bg-tertiary);
    }

    .inventory-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .inventory-table td {
      padding: 16px;
      border-top: 1px solid var(--border-color);
    }

    .inventory-table tr:hover {
      background: var(--bg-tertiary);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-badge.critical {
      background: rgba(255, 71, 87, 0.2);
      color: var(--accent-red);
    }

    .status-badge.low {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-orange);
    }

    .status-badge.ok {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-green);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px 20px;
      min-width: 300px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideInRight 0.3s ease-out;
      z-index: 2000;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast.success {
      border-color: var(--accent-green);
    }

    .toast.error {
      border-color: var(--accent-red);
    }

    .toast-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast-icon {
      font-size: 24px;
    }

    .toast-message {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toast-text {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .upload-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-card:hover {
      border-color: var(--accent-red);
      transform: translateY(-2px);
    }

    .upload-card-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .upload-card-title {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .upload-card-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--accent-blue);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      font-size: 14px;
      margin-bottom: 10px;
      color: var(--accent-blue);
    }

    .info-box ul {
      margin-left: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .info-box li {
      margin-bottom: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .empty-state p {
      font-size: 14px;
      margin-bottom: 20px;
    }

    .recipe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .recipe-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }

    .recipe-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      border-color: var(--accent-red);
    }

    .recipe-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .recipe-content {
      padding: 20px;
    }

    .recipe-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .recipe-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .recipe-category {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255, 71, 87, 0.2);
      color: var(--accent-red);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .recipe-meta {
      display: flex;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .recipe-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .recipe-detail-modal .modal {
      max-width: 900px;
    }

    .recipe-detail-header {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
    }

    .recipe-detail-image {
      width: 300px;
      height: 300px;
      object-fit: cover;
      border-radius: 12px;
      flex-shrink: 0;
    }

    .recipe-detail-info {
      flex: 1;
    }

    .recipe-detail-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 15px;
    }

    .recipe-detail-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .recipe-detail-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 14px;
    }

    .recipe-section {
      margin-bottom: 30px;
    }

    .recipe-section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ingredients-list {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }

    .ingredient-item {
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ingredient-quantity {
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-cyan);
    }

    .instructions-list {
      list-style: none;
      counter-reset: step-counter;
    }

    .instruction-item {
      counter-increment: step-counter;
      padding: 15px;
      padding-left: 60px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 10px;
      position: relative;
      font-size: 14px;
      line-height: 1.6;
    }

    .instruction-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: var(--accent-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .recipe-notes {
      padding: 15px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--accent-blue);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .recipe-grid {
        grid-template-columns: 1fr;
      }

      .recipe-detail-header {
        flex-direction: column;
      }

      .recipe-detail-image {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .prediction-main {
        grid-template-columns: 1fr;
      }

      .action-cards {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .alert-content {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stat-card {
      animation: fadeIn 0.5s ease-out backwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }
  
/* ---- Order Guide (print-style) ---- */
.og-sheet{
  background:#ffffff;
  color:#111827;
  border-radius:14px;
  padding:14px;
  border:1px solid #e5e7eb;
}
.og-sheet *{color:#111827;}
.og-header{
  text-align:center;
  border-bottom:2px solid #111827;
  padding-bottom:8px;
  margin-bottom:12px;
}
.og-header .og-title{
  font-weight:900;
  letter-spacing:.08em;
  font-size:14px;
}
.og-header .og-week{
  margin-top:4px;
  font-weight:700;
  font-size:12px;
}
.og-two-col{
  column-count:2;
  column-gap:14px;
}
@media(max-width:900px){
  .og-two-col{column-count:1;}
}
.og-block{
  break-inside:avoid;
  border:2px solid #111827;
  margin:0 0 12px 0;
}
.og-supplier{
  background:#f3f4f6;
  border-bottom:2px solid #111827;
  font-weight:900;
  padding:6px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:12px;
}
.og-supplier small{
  font-weight:800;
  color:#374151;
}
.og-table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}
.og-table th, .og-table td{
  border:1px solid #111827;
  padding:4px 6px;
  font-size:11px;
  vertical-align:middle;
}
.og-table th{
  background:#f9fafb;
  font-weight:900;
  text-transform:none;
  letter-spacing:0;
}
.og-table .og-item{
  font-weight:800;
  width:42%;
}
.og-table .og-day{
  width:7%;
  text-align:center;
}
.og-table .og-par{
  width:10%;
  text-align:center;
  font-weight:900;
}
.og-input{
  width:100%;
  border:none;
  outline:none;
  font:inherit;
  padding:2px 3px;
  text-align:center;
  background:transparent;
}
.og-input:focus{
  background:#fff7ed;
}
.og-notes{
  margin-top:12px;
  border:2px solid #111827;
}
.og-notes .og-notes-title{
  background:#f3f4f6;
  border-bottom:2px solid #111827;
  font-weight:900;
  padding:6px 10px;
  font-size:12px;
}
.og-notes textarea{
  width:100%;
  min-height:120px;
  border:none;
  padding:10px;
  font-family:inherit;
  font-size:12px;
  resize:vertical;
  background:transparent;
  color:#111827;
}
.og-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:14px;
}
@media print{
  body{background:#ffffff !important;}
  .sidebar, .top-bar, .tabs, .section-header, .btn, .modal-header, .close-btn, .toast{display:none !important;}
  .modal-overlay{position:static !important; background:transparent !important;}
  .modal{box-shadow:none !important; max-width:none !important; width:100% !important; background:transparent !important;}
  .og-sheet{border:none !important; padding:0 !important;}
  .og-two-col{column-count:2;}
}

</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Storage utility functions
    const StorageAPI = {
      async get(key, shared = false) {
        try {
          const result = await window.storage.get(key, shared);
          return result ? JSON.parse(result.value) : null;
        } catch (error) {
          console.log('Key not found:', key);
          return null;
        }
      },

      async set(key, value, shared = false) {
        try {
          await window.storage.set(key, JSON.stringify(value), shared);
          return true;
        } catch (error) {
          console.error('Storage error:', error);
          return false;
        }
      }
    };

    // Analytics Engine - FIXED VERSION
    const AnalyticsEngine = {
      calculateFoodCost(salesData) {
        if (!salesData || salesData.length === 0) return 0;
        
        let totalRevenue = 0;
        let totalCost = 0;
        
        salesData.forEach(sale => {
          const revenue = parseFloat(sale.revenue || sale.Revenue || 0);
          const cost = parseFloat(sale.cost || sale.Cost || 0);
          
          if (!isNaN(revenue)) totalRevenue += revenue;
          if (!isNaN(cost)) totalCost += cost;
        });
        
        console.log('Food Cost Calc:', { totalRevenue, totalCost, salesDataLength: salesData.length });
        
        if (totalRevenue === 0) return 0;
        return ((totalCost / totalRevenue) * 100).toFixed(1);
      },

      calculateWaste(wasteData, salesData) {
        if (!wasteData || wasteData.length === 0) return 0;
        
        let totalWaste = 0;
        let totalSales = 0;
        
        wasteData.forEach(item => {
          const wasteCost = parseFloat(item.cost || item.Cost || 0);
          if (!isNaN(wasteCost)) totalWaste += wasteCost;
        });
        
        if (salesData && salesData.length > 0) {
          salesData.forEach(sale => {
            const revenue = parseFloat(sale.revenue || sale.Revenue || 0);
            if (!isNaN(revenue)) totalSales += revenue;
          });
        }
        
        console.log('Waste Calc:', { totalWaste, totalSales, wasteDataLength: wasteData.length });
        
        if (totalSales === 0) return 0;
        return ((totalWaste / totalSales) * 100).toFixed(1);
      },

      calculateLabor(laborData) {
        if (!laborData || laborData.length === 0) return 0;
        
        let total = 0;
        
        laborData.forEach(entry => {
          const hours = parseFloat(entry.hours || entry.Hours || 0);
          const rate = parseFloat(entry.rate || entry.Rate || 0);
          
          if (!isNaN(hours) && !isNaN(rate)) {
            total += hours * rate;
          }
        });
        
        console.log('Labor Calc:', { total, laborDataLength: laborData.length });
        
        return Math.round(total);
      },

      predictCovers(salesData) {
        if (!salesData || salesData.length === 0) return 0;
        
        const recent = salesData.slice(-7);
        let totalCovers = 0;
        let validEntries = 0;
        
        recent.forEach(day => {
          const covers = parseFloat(day.covers || day.Covers || 0);
          if (!isNaN(covers) && covers > 0) {
            totalCovers += covers;
            validEntries++;
          }
        });
        
        const avgCovers = validEntries > 0 ? Math.round(totalCovers / validEntries) : 0;
        
        console.log('Covers Prediction:', { avgCovers, validEntries, totalCovers });
        
        return avgCovers;
      },

      findTopSellingItems(salesData) {
        if (!salesData || salesData.length === 0) return [];
        
        const itemCounts = {};
        
        salesData.forEach(sale => {
          const item = sale.item || sale.Item;
          const quantity = parseFloat(sale.quantity || sale.Quantity || 1);
          
          if (item && !isNaN(quantity)) {
            itemCounts[item] = (itemCounts[item] || 0) + quantity;
          }
        });
        
        const topItems = Object.entries(itemCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([item]) => item);
        
        console.log('Top Items:', topItems);
        
        return topItems;
      },

      analyzeWastePatterns(wasteData) {
        if (!wasteData || wasteData.length === 0) return [];
        
        const patterns = {};
        
        wasteData.forEach(item => {
          const key = item.item || item.Item || 'Unknown';
          const cost = parseFloat(item.cost || item.Cost || 0);
          
          if (!patterns[key]) {
            patterns[key] = { count: 0, totalCost: 0 };
          }
          patterns[key].count++;
          if (!isNaN(cost)) patterns[key].totalCost += cost;
        });
        
        const wastePatterns = Object.entries(patterns)
          .map(([item, data]) => ({
            item,
            occurrences: data.count,
            totalCost: data.totalCost
          }))
          .sort((a, b) => b.totalCost - a.totalCost);
        
        console.log('Waste Patterns:', wastePatterns);
        
        return wastePatterns;
      }
    };

    // Toast component
    const Toast = ({ message, type, onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 4000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return (
        <div className={`toast ${type}`}>
          <div className="toast-content">
            <div className="toast-icon">
              {type === 'success' ? '✓' : '✕'}
            </div>
            <div className="toast-message">
              <div className="toast-title">{type === 'success' ? 'Success' : 'Error'}</div>
              <div className="toast-text">{message}</div>
            </div>
          </div>
        </div>
      );
    };

    

// ---------------------------
// Download helpers (CSV export)
// ---------------------------
const _toCSV = (rows) => Papa.unparse(rows ?? [], { quotes: false });

const _downloadTextFile = (filename, text, mime = 'text/csv;charset=utf-8;') => {
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

const _downloadCSV = (filename, rows) => {
  const csv = _toCSV(rows);
  _downloadTextFile(filename, csv, 'text/csv;charset=utf-8;');
};

// Main App Component
    const ChefOpsAI = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [showAlert, setShowAlert] = useState(true);
      const [modalOpen, setModalOpen] = useState(null);
      const [inventory, setInventory] = useState([]);
      const [inventoryFocus, setInventoryFocus] = useState(null);
      const [orders, setOrders] = useState([]);
      const [orderGuides, setOrderGuides] = useState([]);
      const [salesData, setSalesData] = useState([]);
      const [wasteData, setWasteData] = useState([]);
      const [laborData, setLaborData] = useState([]);
      const [recipes, setRecipes] = useState([]);
      const [banquetEvents, setBanquetEvents] = useState([]);
      const [banquetMenu, setBanquetMenu] = useState([]);
      const [loading, setLoading] = useState(true);
      const [toast, setToast] = useState(null);
      const [restaurantInfo, setRestaurantInfo] = useState({
        name: 'Marrakesh CC',
        location: 'Palm Desert'
      });

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        setLoading(true);
        try {
          const [invData, ordersData, orderGuidesData, salesDataStored, wasteDataStored, laborDataStored, recipesData, banquetEventsStored, banquetMenuStored, resInfo] = await Promise.all([
            StorageAPI.get('inventory'),
            StorageAPI.get('orders'),
            StorageAPI.get('order-guides'),
            StorageAPI.get('sales-data'),
            StorageAPI.get('waste-data'),
            StorageAPI.get('labor-data'),
            StorageAPI.get('recipes'),
            StorageAPI.get('banquet-events'),
            StorageAPI.get('banquet-menu'),
            StorageAPI.get('restaurant-info')
          ]);

          if (invData) setInventory(invData);
          else {
            const sampleInventory = [
              { id: 1, name: 'Chicken Breast', category: 'Protein', current: 15, min: 20, unit: 'lbs', unitCost: 4.99, supplier: 'Fresh Meats Co' },
              { id: 2, name: 'Salmon Fillet', category: 'Protein', current: 8, min: 10, unit: 'lbs', unitCost: 12.99, supplier: 'Ocean Fresh' },
              { id: 3, name: 'Ribeye Steak', category: 'Protein', current: 25, min: 15, unit: 'lbs', unitCost: 15.99, supplier: 'Prime Cuts' },
            ];
            setInventory(sampleInventory);
            await StorageAPI.set('inventory', sampleInventory);
          }

          if (ordersData) setOrders(ordersData);
          if (orderGuidesData) setOrderGuides(orderGuidesData);
          else setOrderGuides([]);

          
          if (recipesData) {
            console.log('Loaded recipes:', recipesData.length);
            setRecipes(recipesData);
          } else {
            // Sample recipes
            const sampleRecipes = [
              {
                id: 1,
                name: 'Grilled Ribeye Steak',
                category: 'Entree',
                prepTime: 15,
                cookTime: 20,
                servings: 1,
                image: 'https://images.unsplash.com/photo-1558030006-450675393462?w=400',
                ingredients: [
                  { item: 'Ribeye Steak', quantity: 12, unit: 'oz' },
                  { item: 'Salt', quantity: 1, unit: 'tsp' },
                  { item: 'Black Pepper', quantity: 1, unit: 'tsp' },
                  { item: 'Olive Oil', quantity: 2, unit: 'tbsp' },
                  { item: 'Butter', quantity: 2, unit: 'tbsp' },
                  { item: 'Garlic', quantity: 2, unit: 'cloves' }
                ],
                instructions: [
                  'Remove steak from refrigerator 30 minutes before cooking',
                  'Season both sides generously with salt and pepper',
                  'Heat cast iron skillet over high heat',
                  'Add olive oil and sear steak 4-5 minutes per side for medium-rare',
                  'Add butter and garlic in last 2 minutes, baste steak',
                  'Rest for 5 minutes before serving'
                ],
                notes: 'Internal temp should reach 130°F for medium-rare'
              },
              {
                id: 2,
                name: 'Pan-Seared Salmon',
                category: 'Entree',
                prepTime: 10,
                cookTime: 12,
                servings: 1,
                image: 'https://images.unsplash.com/photo-1485921325833-c519f76c4927?w=400',
                ingredients: [
                  { item: 'Salmon Fillet', quantity: 6, unit: 'oz' },
                  { item: 'Salt', quantity: 0.5, unit: 'tsp' },
                  { item: 'Lemon', quantity: 0.5, unit: 'whole' },
                  { item: 'Olive Oil', quantity: 1, unit: 'tbsp' },
                  { item: 'Dill', quantity: 1, unit: 'tbsp' }
                ],
                instructions: [
                  'Pat salmon dry with paper towels',
                  'Season with salt and pepper',
                  'Heat olive oil in non-stick pan over medium-high heat',
                  'Place salmon skin-side down, cook 5-6 minutes',
                  'Flip and cook 3-4 minutes until done',
                  'Finish with lemon juice and fresh dill'
                ],
                notes: 'Skin should be crispy, flesh should flake easily'
              }
            ];
            setRecipes(sampleRecipes);
            await StorageAPI.set('recipes', sampleRecipes);
          }
          
          if (salesDataStored) {
            console.log('Loaded sales data:', salesDataStored.length, 'records');
            setSalesData(salesDataStored);
          }
          if (wasteDataStored) {
            console.log('Loaded waste data:', wasteDataStored.length, 'records');
            setWasteData(wasteDataStored);
          }
          if (laborDataStored) {
            console.log('Loaded labor data:', laborDataStored.length, 'records');
            setLaborData(laborDataStored);
          }
          if (resInfo) setRestaurantInfo(resInfo);

        } catch (error) {
          console.error('Error loading data:', error);
          showToast('Error loading data', 'error');
        } finally {
          setLoading(false);
        }
      };

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
      };

      const parseFile = (file) => {
        return new Promise((resolve, reject) => {
          const fileName = file.name.toLowerCase();
          
          // Handle XLSX/XLS files
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                console.log('Parsed XLSX data:', jsonData);
                if (jsonData.length === 0) {
                  reject(new Error('Excel file is empty'));
                  return;
                }
                resolve(jsonData);
              } catch (error) {
                console.error('XLSX parse error:', error);
                reject(error);
              }
            };
            reader.onerror = () => reject(new Error('Failed to read Excel file'));
            reader.readAsArrayBuffer(file);
          }
          // Handle CSV files
          else if (fileName.endsWith('.csv')) {
            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: false,
              transformHeader: (h) => (h || '').replace(/^\uFEFF/, '').trim(),
              delimitersToGuess: [',', '\t', ';', '|'],
              complete: (results) => {
                console.log('Parsed CSV data:', results.data);
                if (results.data.length === 0) {
                  reject(new Error('CSV file is empty'));
                  return;
                }
                if (results.errors.length > 0) {
                  console.warn('CSV parsing warnings:', results.errors);
                }
                resolve(results.data);
              },
              error: (error) => reject(error)
            });
          } else {
            reject(new Error('Please upload a CSV or Excel (.xlsx/.xls) file'));
          }
        });
      };


// ---------------------------
// Inventory import helpers (FIX)
// - Handles "standard" inventory CSVs (headers like name/current/unitCost...)
// - Handles "ALL_SHEETS - EXACT_LONG" style (Sheet, RowInSheet, Col1..ColN)
// - Handles exports with "Unnamed:" columns by auto-detecting best columns
// ---------------------------
const _stripBOM = (s) => (typeof s === 'string' ? s.replace(/^\uFEFF/, '') : s);

const _normKey = (k) => _stripBOM(String(k ?? ''))
  .trim()
  .toLowerCase()
  .replace(/\s+/g, ' ')
  .replace(/[^a-z0-9 ]/g, '');

const _isEmpty = (v) => v === null || v === undefined || (typeof v === 'string' && v.trim() === '');

const _parseNumber = (v) => {
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
  let s = String(v).trim();
  if (!s) return 0;
  // strip currency and commas
  s = s.replace(/\$/g, '').replace(/,/g, '');
  // (123.45) -> -123.45
  const paren = /^\((.*)\)$/.exec(s);
  if (paren) s = '-' + paren[1];
  const m = s.match(/-?\d+(\.\d+)?/);
  if (!m) return 0;
  const n = parseFloat(m[0]);
  return Number.isFinite(n) ? n : 0;
};

const _looksLikeUnit = (val) => {
  if (typeof val !== 'string') return false;
  const t = val.trim().toLowerCase().replace(/\./g,'');
  if (!t || t.length > 10) return false;
  const units = new Set(['ea','each','lb','lbs','#','oz','kg','g','l','lt','ml','gal','qt','pt','cs','case','cases','sack','bag','box','bottle','bt','can','tin','doz','dz','pack','pk','tray','bunch','head','ct']);
  return units.has(t);
};

const _guessTextColumn = (rows, columns) => {
  const sample = rows.slice(0, 400);
  let best = {col: '', score: -1};
  columns.forEach(col => {
    if (_normKey(col) === 'sheet') return;
    let textCount = 0, unitLike = 0, avgLen = 0;
    sample.forEach(r => {
      const v = r[col];
      if (_isEmpty(v)) return;
      const s = String(v);
      if (/[a-zA-Z]/.test(s)) {
        textCount++;
        avgLen += s.length;
        if (_looksLikeUnit(s)) unitLike++;
      }
    });
    if (textCount === 0) return;
    avgLen = avgLen / Math.max(1, textCount);
    const score = (textCount * 2) + (avgLen) - (unitLike * 3);
    if (score > best.score) best = {col, score};
  });
  return best.col;
};

const _guessUnitColumn = (rows, columns, excludeCols = new Set()) => {
  const sample = rows.slice(0, 400);
  let best = {col: '', score: -1};
  columns.forEach(col => {
    if (excludeCols.has(col)) return;
    if (_normKey(col) === 'sheet') return;
    let unitLike = 0;
    sample.forEach(r => {
      const v = r[col];
      if (_isEmpty(v)) return;
      if (_looksLikeUnit(String(v))) unitLike++;
    });
    if (unitLike >= 6 && unitLike > best.score) best = {col, score: unitLike};
  });
  return best.col;
};

const _guessNumericColumns = (rows, columns, excludeCols = new Set()) => {
  const sample = rows.slice(0, 400);
  const stats = columns
    .filter(c => !excludeCols.has(c) && _normKey(c) !== 'sheet')
    .map(c => {
      let numCount = 0;
      let vals = [];
      sample.forEach(r => {
        const v = r[c];
        if (_isEmpty(v)) return;
        const n = _parseNumber(v);
        if (n !== 0 || /-?\d/.test(String(v))) {
          if (Number.isFinite(n)) {
            numCount++;
            if (n > 0) vals.push(n);
          }
        }
      });
      vals.sort((a,b)=>a-b);
      const med = vals.length ? vals[Math.floor(vals.length/2)] : 0;
      return {c, numCount, med};
    })
    .filter(o => o.numCount >= 10)
    .sort((a,b)=>b.numCount - a.numCount);

  return stats;
};

const _mapInventoryFlat = (data) => {
  const rows = Array.isArray(data) ? data : [];
  if (!rows.length) return [];

  const columns = Object.keys(rows[0] || {});
  const byNorm = {};
  columns.forEach(c => { if (!byNorm[_normKey(c)]) byNorm[_normKey(c)] = c; });

  let nameCol =
    byNorm['name'] || byNorm['item'] || byNorm['product'] || byNorm['description'] || byNorm['ingredient'] || byNorm['inventory item'];

  if (!nameCol) nameCol = _guessTextColumn(rows, columns);

  const exclude = new Set([nameCol].filter(Boolean));
  let unitCol = byNorm['unit'] || byNorm['uom'] || byNorm['measure'] || byNorm['units'];
  if (!unitCol) unitCol = _guessUnitColumn(rows, columns, exclude);
  if (unitCol) exclude.add(unitCol);

  const currentCol =
    byNorm['current'] || byNorm['qty'] || byNorm['quantity'] || byNorm['on hand'] || byNorm['onhand'] ||
    byNorm['stock'] || byNorm['count'] || byNorm['total qty'] || byNorm['total quantity'] || byNorm['total'];

  const unitCostCol =
    byNorm['unit cost'] || byNorm['unitcost'] || byNorm['unit price'] || byNorm['price'] || byNorm['cost'];

  const totalCostCol =
    byNorm['total cost'] || byNorm['totalcost'] || byNorm['extended cost'] || byNorm['ext cost'] || byNorm['value'] || byNorm['amount'];

  const minCol =
    byNorm['min'] || byNorm['minimum'] || byNorm['par'] || byNorm['par level'] || byNorm['reorder'] || byNorm['reorder point'];

  const supplierCol =
    byNorm['supplier'] || byNorm['vendor'] || byNorm['purveyor'];

  const categoryCol =
    byNorm['category'] || byNorm['dept'] || byNorm['department'] || byNorm['group'] || byNorm['type'];

  const sheetCol = byNorm['sheet'] || byNorm['period'] || byNorm['month'];

  // Fallback numeric detection if current/unitCost not found (common for "Unnamed:" exports)
  const numericStats = _guessNumericColumns(rows, columns, new Set([nameCol, unitCol].filter(Boolean)));
  const medSorted = numericStats.slice().sort((a,b)=>a.med - b.med);
  const fallbackCurrent = currentCol || (medSorted[0]?.c || '');
  const fallbackUnitCost = unitCostCol || (medSorted.find(o => o.c !== fallbackCurrent)?.c || '');
  const fallbackTotalCost = totalCostCol || (medSorted.slice().reverse().find(o => o.c !== fallbackCurrent && o.c !== fallbackUnitCost)?.c || '');

  const mapped = [];
  for (let i=0;i<rows.length;i++){
    const r = rows[i];
    const rawName = nameCol ? r[nameCol] : undefined;
    const name = String(rawName ?? '').trim();
    if (!name) continue;

    // skip obvious title rows
    const nl = name.toLowerCase();
    if (nl === 'food inventory' || nl === 'inventory' || nl.startsWith('--- sheet')) continue;

    const unit = unitCol ? String(r[unitCol] ?? '').trim() : '';

    const currentVal = currentCol ? r[currentCol] : (fallbackCurrent ? r[fallbackCurrent] : undefined);
    const current = _parseNumber(currentVal);

    const totalCostVal = totalCostCol ? r[totalCostCol] : (fallbackTotalCost ? r[fallbackTotalCost] : undefined);
    const totalCost = _parseNumber(totalCostVal);

    const unitCostVal = unitCostCol ? r[unitCostCol] : (fallbackUnitCost ? r[fallbackUnitCost] : undefined);
    let unitCost = _parseNumber(unitCostVal);

    if ((!unitCost || unitCost === 0) && totalCost > 0 && current > 0) {
      unitCost = totalCost / current;
    }

    const minVal = minCol ? r[minCol] : undefined;
    const min = _parseNumber(minVal);

    const supplier = supplierCol ? String(r[supplierCol] ?? '').trim() : '';

    const category =
      (categoryCol ? String(r[categoryCol] ?? '').trim() : '') ||
      (sheetCol ? String(r[sheetCol] ?? '').trim() : '') ||
      'Other';

    mapped.push({
      id: Date.now() + i,
      name,
      category,
      current,
      min,
      unit: unit || 'ea',
      unitCost,
      supplier: supplier || 'Unknown'
    });
  }

  return mapped;
};

const _mapInventoryGridLong = (data) => {
  if (!Array.isArray(data) || !data.length) return [];

  const cols = Object.keys(data[0] || {});
  const sheetKey = cols.find(c => _normKey(c) === 'sheet') || 'Sheet';
  const rowKey = cols.find(c => ['rowinsheet','row in sheet','row'].includes(_normKey(c))) || 'RowInSheet';

  const colKeys = cols
    .filter(k => /^Col\d+$/i.test(k))
    .sort((a,b) => parseInt(a.replace(/\D/g,''),10) - parseInt(b.replace(/\D/g,''),10));

  if (!colKeys.length) return _mapInventoryFlat(data);

  const bySheet = {};
  data.forEach(r => {
    const s = String(r[sheetKey] ?? '').trim();
    if (!s) return;
    if (!bySheet[s]) bySheet[s] = [];
    bySheet[s].push(r);
  });

  const results = [];

  const scoreRowAsHeader = (row) => {
    let score = 0;
    for (const k of colKeys){
      const v = row[k];
      if (_isEmpty(v)) continue;
      const t = String(v).toLowerCase();
      if (t.includes('item')) score += 3;
      if (t.includes('unit')) score += 2;
      if (t.includes('par') || t.includes('min')) score += 2;
      if (t.includes('total') && (t.includes('qty') || t.includes('quantity'))) score += 4;
      if (t.includes('unit cost') || (t === 'cost')) score += 3;
      if (t.includes('total cost')) score += 4;
    }
    return score;
  };

  const roleForHeader = (label) => {
    const t = (label || '').toLowerCase();
    if (!t) return '';
    if (t.includes('item') || t.includes('product') || t.includes('description')) return 'name';
    if (t === 'unit' || t.includes('uom')) return 'unit';
    if (t.includes('par') || t.includes('minimum') || t.includes('min') || t.includes('reorder')) return 'min';
    if (t.includes('total') && (t.includes('qty') || t.includes('quantity'))) return 'current';
    if (t.includes('unit cost') || (t === 'cost') || t.includes('unit price') || t === 'price') return 'unitCost';
    if (t.includes('total cost') || t.includes('extended')) return 'totalCost';
    return '';
  };

  Object.entries(bySheet).forEach(([sheetName, rows]) => {
    rows.sort((a,b) => _parseNumber(a[rowKey]) - _parseNumber(b[rowKey]));

    let headerIdx = -1;
    let bestScore = 0;
    for (let i=0;i<rows.length;i++){
      const s = scoreRowAsHeader(rows[i]);
      if (s > bestScore){
        bestScore = s;
        headerIdx = i;
      }
    }

    if (headerIdx < 0 || bestScore < 6){
      const flat = _mapInventoryFlat(rows.map(r => {
        const o = {};
        colKeys.forEach(k => o[k] = r[k]);
        o.Sheet = sheetName;
        return o;
      }));
      flat.forEach(it => { it.category = it.category || sheetName; });
      results.push(...flat);
      return;
    }

    const headerRow = rows[headerIdx];
    const headerLabels = colKeys.map(k => _normKey(headerRow[k] ?? ''));

    const roleByCol = {};
    colKeys.forEach((k, i) => {
      const role = roleForHeader(headerLabels[i]);
      if (role) roleByCol[k] = role;
    });

    const nameCol = colKeys.find(k => roleByCol[k] === 'name') || colKeys[0];
    const unitCol = colKeys.find(k => roleByCol[k] === 'unit') || '';
    const currentCol = colKeys.find(k => roleByCol[k] === 'current') || '';
    const minCol = colKeys.find(k => roleByCol[k] === 'min') || '';
    const unitCostCol = colKeys.find(k => roleByCol[k] === 'unitCost') || '';
    const totalCostCol = colKeys.find(k => roleByCol[k] === 'totalCost') || '';

    const locationCols = colKeys.filter(k => !roleByCol[k] && !_isEmpty(headerRow[k]));

    let currentCategory = sheetName;
    let emptyStreak = 0;

    for (let i=headerIdx+1;i<rows.length;i++){
      const r = rows[i];
      const rawName = r[nameCol];
      const name = String(rawName ?? '').trim();
      if (!name) {
        emptyStreak++;
        if (emptyStreak >= 8) break;
        continue;
      }
      emptyStreak = 0;

      if (scoreRowAsHeader(r) >= bestScore - 1) continue;

      const otherNonEmpty = colKeys.reduce((acc,k)=>{
        if (k === nameCol) return acc;
        return acc + (!_isEmpty(r[k]) ? 1 : 0);
      }, 0);

      if (otherNonEmpty <= 1 && name.length <= 40 && name === name.toUpperCase()){
        currentCategory = name;
        continue;
      }

      let current = currentCol ? _parseNumber(r[currentCol]) : 0;
      if ((currentCol && _isEmpty(r[currentCol])) && locationCols.length){
        current = locationCols.reduce((sum,k)=>sum + _parseNumber(r[k]), 0);
      } else if (!currentCol && locationCols.length){
        current = locationCols.reduce((sum,k)=>sum + _parseNumber(r[k]), 0);
      }

      const unit = unitCol ? String(r[unitCol] ?? '').trim() : '';
      let unitCost = unitCostCol ? _parseNumber(r[unitCostCol]) : 0;
      const totalCost = totalCostCol ? _parseNumber(r[totalCostCol]) : 0;
      if ((!unitCost || unitCost === 0) && totalCost > 0 && current > 0){
        unitCost = totalCost / current;
      }

      const min = minCol ? _parseNumber(r[minCol]) : 0;

      results.push({
        id: Date.now() + results.length,
        name,
        category: currentCategory || sheetName,
        current,
        min,
        unit: unit || 'ea',
        unitCost,
        supplier: 'Unknown'
      });
    }
  });

  return results.filter(it => it.name && it.name.toLowerCase() !== 'food inventory');
};

const _mapInventoryData = (data) => {
  if (!Array.isArray(data) || !data.length) return [];
  const columns = Object.keys(data[0] || {});
  const hasSheet = columns.some(c => _normKey(c) === 'sheet');
  const hasCol = columns.some(c => /^Col\d+$/i.test(c));
  if (hasSheet && hasCol) return _mapInventoryGridLong(data);
  return _mapInventoryFlat(data);
};

      const handleFileUpload = async (file, dataType) => {
        try {
          const data = await parseFile(file);
          console.log(`Uploading ${dataType}:`, data);
          
          switch(dataType) {
            case 'sales':
              setSalesData(data);
              await StorageAPI.set('sales-data', data);
              showToast(`Uploaded ${data.length} sales records! Dashboard updated.`);
              console.log('Sales data saved and state updated');
              break;
            case 'waste':
              setWasteData(data);
              await StorageAPI.set('waste-data', data);
              showToast(`Uploaded ${data.length} waste records! Dashboard updated.`);
              console.log('Waste data saved and state updated');
              break;
            case 'labor':
              setLaborData(data);
              await StorageAPI.set('labor-data', data);
              showToast(`Uploaded ${data.length} labor records! Dashboard updated.`);
              console.log('Labor data saved and state updated');
              break;
            case 'inventory':
              console.log('Raw inventory data from file:', data);
              console.log('First row example:', data[0]);

              const mappedInventory = _mapInventoryData(data);

              console.log('Mapped inventory (fixed) count:', mappedInventory.length);
              console.log('Mapped inventory sample:', mappedInventory.slice(0, 5));

              if (!mappedInventory.length) {
                throw new Error('No inventory rows detected. Try exporting a cleaner CSV or check the file format.');
              }

              setInventory(mappedInventory);
              await StorageAPI.set('inventory', mappedInventory);
              showToast(`Uploaded ${mappedInventory.length} inventory items!`);
              break;
          }
          
          setModalOpen(null);
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showToast('Error parsing file. Check console for details.', 'error');
        }
      };

      const addInventoryItem = async (item) => {
        const newItem = { ...item, id: Date.now() };
        const updatedInventory = [...inventory, newItem];
        setInventory(updatedInventory);
        await StorageAPI.set('inventory', updatedInventory);
        showToast('Item added successfully!');
        setModalOpen(null);
      };

      const updateInventoryItem = async (id, updates) => {
        const updatedInventory = inventory.map(item =>
          item.id === id ? { ...item, ...updates } : item
        );
        setInventory(updatedInventory);
        await StorageAPI.set('inventory', updatedInventory);
        showToast('Item updated successfully!');
      };

      const deleteInventoryItem = async (id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        const updatedInventory = inventory.filter(item => item.id !== id);
        setInventory(updatedInventory);
        await StorageAPI.set('inventory', updatedInventory);
        showToast('Item deleted successfully!');
      };

      const createOrder = async (items) => {
        const newOrder = {
          id: Date.now(),
          date: new Date().toISOString(),
          items: items,
          status: 'pending',
          total: items.reduce((sum, item) => sum + (item.qty * item.unitCost), 0)
        };
        const updatedOrders = [...orders, newOrder];
        setOrders(updatedOrders);
        await StorageAPI.set('orders', updatedOrders);
        showToast('Order created successfully!');
        setModalOpen(null);
      };

      const quickOrder = async (itemId) => {
        const item = inventory.find(i => i.id === itemId);
        if (!item) return;

        const qtyNeeded = item.min - item.current;
        const orderItem = {
          itemId: item.id,
          name: item.name,
          qty: qtyNeeded,
          unitCost: item.unitCost,
          supplier: item.supplier
        };

        await createOrder([orderItem]);
      };

      // ---------------------------
      // Order Guides (Inventory order guide history)
      // ---------------------------

      const _sumDays = (days) => {
        if (!days) return 0;
        const keys = ['sun','mon','tue','wed','thu','fri','sat'];
        return keys.reduce((s, k) => s + _parseNumber(days[k] ?? days[k.toUpperCase()] ?? days[k[0].toUpperCase() + k.slice(1)]), 0);
      };

      const _getGuideLineQty = (line) => {
        if (!line) return 0;
        if (line.days) return _sumDays(line.days);
        if (line.byDay) return _sumDays(line.byDay);
        return _parseNumber(line.qty);
      };

      const createOrderGuide = async (guide) => {
        const newGuide = {
          ...guide,
          id: guide.id || Date.now(),
          date: guide.date || new Date().toISOString(),
          status: guide.status || 'draft',
        };
        const updatedGuides = [newGuide, ...(orderGuides || [])];
        setOrderGuides(updatedGuides);
        await StorageAPI.set('order-guides', updatedGuides);
        showToast('Order guide saved!');
        setModalOpen(null);
      };

      const deleteOrderGuide = async (guideId) => {
        if (!confirm('Delete this order guide?')) return;
        const updatedGuides = (orderGuides || []).filter(g => g.id !== guideId);
        setOrderGuides(updatedGuides);
        await StorageAPI.set('order-guides', updatedGuides);
        showToast('Order guide deleted.');
      };

      const applyOrderGuideToInventory = async (guideId) => {
        const guide = (orderGuides || []).find(g => g.id === guideId);
        if (!guide) return;
        if (guide.appliedToInventory) {
          showToast('This order guide was already applied to inventory.', 'error');
          return;
        }
        if (!confirm('Apply ordered quantities to inventory now? (This will add qty to current stock)')) return;

        let appliedCount = 0;

        const updatedInventory = inventory.map(it => {
          const line = (guide.items || []).find(x => x.itemId === it.id);
          if (!line) return it;
          const qty = _getGuideLineQty(line);
          if (qty <= 0) return it;
          appliedCount++;
          return { ...it, current: _parseNumber(it.current) + qty };
        });

        setInventory(updatedInventory);
        await StorageAPI.set('inventory', updatedInventory);

        const updatedGuides = (orderGuides || []).map(g => {
          if (g.id !== guideId) return g;
          return {
            ...g,
            status: 'received',
            appliedToInventory: true,
            appliedAt: new Date().toISOString(),
          };
        });

        setOrderGuides(updatedGuides);
        await StorageAPI.set('order-guides', updatedGuides);

        showToast(`Applied ${appliedCount} items to inventory.`);
      };



      const addRecipe = async (recipe) => {
        const newRecipe = {
          ...recipe,
          id: Date.now(),
        };
        const updatedRecipes = [...recipes, newRecipe];
        setRecipes(updatedRecipes);
        await StorageAPI.set('recipes', updatedRecipes);
        showToast('Recipe added successfully!');
        setModalOpen(null);
      };

      const deleteRecipe = async (id) => {
        if (!confirm('Are you sure you want to delete this recipe?')) return;
        const updatedRecipes = recipes.filter(recipe => recipe.id !== id);
        setRecipes(updatedRecipes);
        await StorageAPI.set('recipes', updatedRecipes);
        showToast('Recipe deleted successfully!');
      };

      const applyPrepRecommendation = async () => {
        showToast('Prep recommendation applied!');
        setShowAlert(false);
      };

      // Calculate stats with real data
      const calculateStats = () => {
        const lowStockItems = inventory.filter(item => item.current < item.min);
        
        const foodCost = parseFloat(AnalyticsEngine.calculateFoodCost(salesData));
        const waste = parseFloat(AnalyticsEngine.calculateWaste(wasteData, salesData));
        const labor = AnalyticsEngine.calculateLabor(laborData);
        const predictedCovers = AnalyticsEngine.predictCovers(salesData);
        const topItems = AnalyticsEngine.findTopSellingItems(salesData);
        
        return {
          foodCost: foodCost || 0,
          waste: waste || 0,
          labor: labor || 0,
          lowStock: lowStockItems.length,
          predictedCovers: predictedCovers || 0,
          topItems: topItems
        };
      };

      const stats = calculateStats();

      const getItemStatus = (item) => {
        if (item.current < item.min * 0.5) return 'critical';
        if (item.current < item.min) return 'low';
        return 'ok';
      };

      // Upload Modal Component
      const UploadModal = () => {
        const [uploadType, setUploadType] = useState(null);
        const [previewData, setPreviewData] = useState(null);
        const [dragOver, setDragOver] = useState(false);

        const handleFileChange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            const data = await parseFile(file);
            setPreviewData({ data: data.slice(0, 5), file, total: data.length });
          } catch (error) {
            showToast('Error reading file', 'error');
          }
        };

        const handleDrop = async (e) => {
          e.preventDefault();
          setDragOver(false);
          
          const file = e.dataTransfer.files[0];
          if (!file) return;

          try {
            const data = await parseFile(file);
            setPreviewData({ data: data.slice(0, 5), file, total: data.length });
          } catch (error) {
            showToast('Error reading file', 'error');
          }
        };

        const confirmUpload = () => {
          if (previewData && uploadType) {
            handleFileUpload(previewData.file, uploadType);
          }
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Upload Restaurant Data</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              {!uploadType ? (
                <>
                  <p style={{marginBottom: '20px', color: 'var(--text-secondary)'}}>
                    Choose the type of data you want to upload
                  </p>
                  <div className="upload-grid">
                    <div className="upload-card" onClick={() => setUploadType('sales')}>
                      <div className="upload-card-icon">📊</div>
                      <div className="upload-card-title">Sales Data</div>
                      <div className="upload-card-desc">Daily sales & revenue</div>
                    </div>
                    <div className="upload-card" onClick={() => setUploadType('waste')}>
                      <div className="upload-card-icon">🗑️</div>
                      <div className="upload-card-title">Waste Data</div>
                      <div className="upload-card-desc">Food waste tracking</div>
                    </div>
                    <div className="upload-card" onClick={() => setUploadType('labor')}>
                      <div className="upload-card-icon">👥</div>
                      <div className="upload-card-title">Labor Data</div>
                      <div className="upload-card-desc">Hours & payroll</div>
                    </div>
                    <div className="upload-card" onClick={() => setUploadType('inventory')}>
                      <div className="upload-card-icon">📦</div>
                      <div className="upload-card-title">Inventory</div>
                      <div className="upload-card-desc">Stock levels</div>
                    </div>
                  </div>
                </>
              ) : (
                <>
                  <div className="info-box">
                    <h4>CSV Format for {uploadType}:</h4>
                    <ul>
                      {uploadType === 'sales' && (
                        <>
                          <li>Headers: date, item, quantity, revenue, cost, covers</li>
                          <li>Example: 2026-02-01, Ribeye Steak, 15, 450.00, 150.00, 45</li>
                        </>
                      )}
                      {uploadType === 'waste' && (
                        <>
                          <li>Headers: date, item, quantity, cost, reason</li>
                          <li>Example: 2026-02-01, Salmon, 2, 25.98, Overprep</li>
                        </>
                      )}
                      {uploadType === 'labor' && (
                        <>
                          <li>Headers: date, employee, position, hours, rate</li>
                          <li>Example: 2026-02-01, John Doe, Chef, 8, 25.00</li>
                        </>
                      )}
                      {uploadType === 'inventory' && (
                        <>
                          <li>Headers: name, category, current, min, unit, unitCost, supplier</li>
                          <li>Example: Chicken Breast, Protein, 15, 20, lbs, 4.99, Fresh Meats</li>
                        </>
                      )}
                    </ul>
                  </div>

                  <div 
                    className={`file-upload ${dragOver ? 'drag-over' : ''}`}
                    onDrop={handleDrop}
                    onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                    onDragLeave={() => setDragOver(false)}
                    onClick={() => document.getElementById('file-input').click()}
                  >
                    <input 
                      id="file-input"
                      type="file" 
                      accept=".csv"
                      onChange={handleFileChange}
                    />
                    <div className="upload-icon">📁</div>
                    <div className="upload-text">
                      {previewData ? `${previewData.total} records loaded` : 'Click or drag CSV file here'}
                    </div>
                    <div className="upload-hint">Supports CSV and Excel files (.csv, .xlsx, .xls)</div>
                  </div>

                  {previewData && (
                    <div className="data-preview">
                      <h4 style={{marginBottom: '10px', fontSize: '14px'}}>
                        Preview (first 5 rows of {previewData.total}):
                      </h4>
                      <table className="preview-table">
                        <thead>
                          <tr>
                            {Object.keys(previewData.data[0] || {}).map(key => (
                              <th key={key}>{key}</th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {previewData.data.map((row, idx) => (
                            <tr key={idx}>
                              {Object.values(row).map((val, i) => (
                                <td key={i}>{val}</td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}

                  <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                    <button 
                      className="btn btn-primary" 
                      style={{flex: 1}}
                      disabled={!previewData}
                      onClick={confirmUpload}
                    >
                      Upload & Analyze Data
                    </button>
                    <button 
                      className="btn btn-secondary"
                      onClick={() => setUploadType(null)}
                    >
                      Back
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

      const Dashboard = () => {
        const lowStockItems = inventory.filter(item => item.current < item.min);
        const criticalItems = lowStockItems.filter(item => item.current < item.min * 0.5);
        const wastePatterns = AnalyticsEngine.analyzeWastePatterns(wasteData);

        const hasData = salesData.length > 0 || wasteData.length > 0 || laborData.length > 0;

        return (
          <>
            {showAlert && wastePatterns.length > 0 && (
              <div className="alert-banner">
                <div className="alert-content">
                  <div className="alert-text">
                    <h3>🧠 AI Recommendation</h3>
                    <p>
                      Based on waste analysis: <strong>{wastePatterns[0].item}</strong> has {wastePatterns[0].occurrences} waste events 
                      costing ${wastePatterns[0].totalCost.toFixed(2)}. Consider reducing prep or offering as special.
                    </p>
                  </div>
                  <div className="alert-actions">
                    <button className="btn btn-primary" onClick={applyPrepRecommendation}>
                      Apply
                    </button>
                    <button className="btn btn-secondary" onClick={() => setShowAlert(false)}>
                      Dismiss
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="stats-grid">
              <div className="stat-card" style={{'--accent-color': '#3b82f6', cursor: 'pointer'}} onClick={() => setModalOpen('food-cost')}>
                <div className="stat-header">
                  <div className="stat-icon" style={{background: '#3b82f620', color: '#3b82f6'}}>
                    📊
                  </div>
                  <div className="stat-label">Food Cost</div>
                </div>
                <div className="stat-value">
                  {hasData ? `${stats.foodCost}%` : '-'}
                </div>
                <div className="stat-change positive">
                  {salesData.length > 0 ? `From ${salesData.length} sales records` : 'Upload sales data'}
                </div>
              </div>

              <div className="stat-card" style={{'--accent-color': '#ff4757', cursor: 'pointer'}} onClick={() => setModalOpen('waste')}>
                <div className="stat-header">
                  <div className="stat-icon" style={{background: '#ff475720', color: '#ff4757'}}>
                    🗑️
                  </div>
                  <div className="stat-label">Waste</div>
                </div>
                <div className="stat-value">
                  {hasData ? `${stats.waste}%` : '-'}
                </div>
                <div className="stat-change negative">
                  {wasteData.length > 0 ? `${wasteData.length} waste records` : 'Upload waste data'}
                </div>
              </div>

              <div className="stat-card" style={{'--accent-color': '#10b981', cursor: 'pointer'}} onClick={() => setModalOpen('labor')}>
                <div className="stat-header">
                  <div className="stat-icon" style={{background: '#10b98120', color: '#10b981'}}>
                    👥
                  </div>
                  <div className="stat-label">Labor</div>
                </div>
                <div className="stat-value">
                  {hasData ? `$${stats.labor.toLocaleString()}` : '-'}
                </div>
                <div className="stat-change positive">
                  {laborData.length > 0 ? `From ${laborData.length} time entries` : 'Upload labor data'}
                </div>
              </div>

              <div className="stat-card" style={{'--accent-color': '#f59e0b', cursor: 'pointer'}} onClick={() => { setInventoryFocus('low'); setActiveTab('inventory'); }}>
                <div className="stat-header">
                  <div className="stat-icon" style={{background: '#f59e0b20', color: '#f59e0b'}}>
                    📦
                  </div>
                  <div className="stat-label">Low Stock</div>
                </div>
                <div className="stat-value">{stats.lowStock} items</div>
                <div className="stat-change negative">
                  {stats.lowStock > 0 ? 'Need attention' : 'All items OK'}
                </div>
              </div>
            </div>

            <div className="predictions-section">
              <div className="section-header">
                <div>
                  <h2 className="section-title">Predictions & Forecasts</h2>
                  <p className="section-subtitle">Based on your uploaded data</p>
                </div>
              </div>
              
              <div className="prediction-main">
                <div className="prediction-metric">
                  <div className="metric-label">Predicted Covers</div>
                  <div className="metric-value">
                    {stats.predictedCovers > 0 ? stats.predictedCovers : '-'}
                  </div>
                  <div className="metric-range">
                    {salesData.length > 0 ? `Based on ${salesData.length} days` : 'Upload sales data'}
                  </div>
                  <div className={`confidence-badge ${salesData.length >= 7 ? '' : 'low'}`}>
                    {salesData.length >= 7 ? 'HIGH CONFIDENCE' : salesData.length > 0 ? 'LOW CONFIDENCE' : 'NO DATA'}
                  </div>
                </div>
                
                <div className="prediction-metric">
                  <div className="metric-label">Data Health</div>
                  <div className="metric-value" style={{fontSize: '48px'}}>
                    {hasData ? '✓' : '⚠️'}
                  </div>
                  <div className="metric-range">
                    {hasData ? 'Analytics Active' : 'Awaiting Data'}
                  </div>
                </div>
              </div>

              <div className="prediction-details">
                <div className="detail-item">
                  <div className="detail-label">Top Selling Items</div>
                  <div className="detail-value" style={{color: '#06b6d4'}}>
                    {stats.topItems.length > 0 ? stats.topItems.join(', ') : 'Upload sales data'}
                  </div>
                </div>
                <div className="detail-item">
                  <div className="detail-label">Data Records</div>
                  <div className="detail-value" style={{color: '#f59e0b'}}>
                    Sales: {salesData.length} | Waste: {wasteData.length} | Labor: {laborData.length}
                  </div>
                </div>
              </div>
            </div>

            <div className="action-cards">
              <div className="action-card" onClick={() => setModalOpen('smart-order')}>
                <div className="action-icon">🛒</div>
                <h3 className="action-title">Smart Order</h3>
                <p className="action-description">
                  AI-generated based on pars + forecast
                </p>
                <div className="action-meta">
                  <span>●</span>
                  <span>{lowStockItems.length} items recommended</span>
                </div>
              </div>

              <div className="action-card" onClick={() => setModalOpen('upload')}>
                <div className="action-icon" style={{background: 'linear-gradient(135deg, #3b82f6, #2563eb)'}}>
                  📤
                </div>
                <h3 className="action-title">Upload Data</h3>
                <p className="action-description">
                  Import sales, waste, labor, or inventory
                </p>
                <div className="action-meta">
                  <span>●</span>
                  <span>CSV format supported</span>
                </div>
              </div>
            </div>

            {criticalItems.length > 0 && (
              <div className="critical-alerts">
                <h2 className="section-title" style={{marginBottom: '20px'}}>Critical Alerts</h2>
                
                {criticalItems.slice(0, 2).map(item => (
                  <div key={item.id} className="alert-item" style={{'--alert-color': '#ff4757'}}>
                    <div className="alert-info">
                      <div className="alert-icon-wrapper">⚠️</div>
                      <div className="alert-details">
                        <h4>{item.name} Critical</h4>
                        <p>{item.min - item.current} {item.unit} below par • Current: {item.current} {item.unit}</p>
                      </div>
                    </div>
                    <button 
                      className="alert-action-btn" 
                      style={{background: '#ff4757', color: 'white'}}
                      onClick={() => quickOrder(item.id)}
                    >
                      Order
                    </button>
                  </div>
                ))}
              </div>
            )}
          </>
        );
      };

      const Inventory = ({ focus, clearFocus }) => {
        const [invView, setInvView] = useState('items'); // items | order-guides
        const [guideFilter, setGuideFilter] = useState(''); // for history search

        const [itemFilter, setItemFilter] = useState('all'); // all | low

        useEffect(() => {
          if (focus === 'low') {
            setInvView('items');
            setItemFilter('low');
            if (typeof clearFocus === 'function') clearFocus();
          }
        }, [focus]);

        const orderedCount = (guide) => (guide.items || []).filter(i => _parseNumber(_getGuideLineQty(i)) > 0).length;

        const filteredInventory = (itemFilter === 'low')
          ? inventory.filter(it => getItemStatus(it) !== 'ok')
          : inventory;

        const filteredGuides = (orderGuides || []).filter(g => {
          const f = guideFilter.trim().toLowerCase();
          if (!f) return true;
          return (g.name || '').toLowerCase().includes(f) ||
                 new Date(g.date || '').toLocaleDateString().toLowerCase().includes(f) ||
                 (g.vendor || '').toLowerCase().includes(f);
        });

        return (
          <div className="predictions-section">
            <div className="section-header">
              <div>
                <h2 className="section-title">
                  {invView === 'items' ? 'Current Inventory' : 'Order Guide'}
                </h2>
                <p className="section-subtitle">
                  {invView === 'items' ? 'Real-time stock levels' : 'Create guides from your full inventory + view history'}
                </p>
              </div>
              <div style={{display: 'flex', gap: '10px'}}>
                {invView === 'items' ? (
                  <>
                    <button className="btn btn-secondary" onClick={() => setModalOpen('upload')}>
                      📤 Import CSV
                    </button>
                    <select
                      value={itemFilter}
                      onChange={(e) => setItemFilter(e.target.value)}
                      className="btn btn-secondary"
                      style={{padding: '10px 12px', borderRadius: '10px'}}
                      title="Filter items"
                    >
                      <option value="all">Show: All items</option>
                      <option value="low">Show: Low + Critical</option>
                    </select>
                    <button className="btn btn-primary" onClick={() => setModalOpen('add-item')}>
                      + Add Item
                    </button>
                  </>
                ) : (
                  <>
                    <button className="btn btn-secondary" onClick={() => _downloadCSV(`order_guides_export_${new Date().toISOString().slice(0,10)}.csv`,
                      (orderGuides || []).flatMap(g => (g.items || []).filter(i => _parseNumber(_getGuideLineQty(i)) > 0).map(i => ({
                        guide_id: g.id,
                        guide_name: g.name || '',
                        date: g.date,
                        item: i.name,
                        qty_total: _getGuideLineQty(i),
                        unit: i.unit || '',
                        supplier: i.supplier || '',
                        unit_cost: i.unitCost || 0,
                        est_total: (_parseNumber(_getGuideLineQty(i)) * _parseNumber(i.unitCost)).toFixed(2)
                      })))
                    )}>
                      ⬇️ Export Ordered History
                    </button>
                    <button className="btn btn-primary" onClick={() => setModalOpen('order-guide')}>
                      🧾 New Order Guide
                    </button>
                  </>
                )}
              </div>
            </div>

            <div className="tabs" style={{marginBottom: '18px'}}>
              <button
                className={`tab ${invView === 'items' ? 'active' : ''}`}
                onClick={() => setInvView('items')}
              >
                Inventory Items
              </button>
              <button
                className={`tab ${invView === 'order-guides' ? 'active' : ''}`}
                onClick={() => setInvView('order-guides')}
              >
                Order Guide & History
              </button>
            </div>

            {invView === 'items' ? (
              <>
                {inventory.length === 0 ? (
                  <div className="empty-state">
                    <div className="empty-state-icon">📦</div>
                    <h3>No inventory items yet</h3>
                    <p>Start by adding items manually or uploading a CSV file</p>
                    <div style={{display: 'flex', gap: '10px', justifyContent: 'center'}}>
                      <button className="btn btn-secondary" onClick={() => setModalOpen('upload')}>
                        Upload CSV
                      </button>
                      <button className="btn btn-primary" onClick={() => setModalOpen('add-item')}>
                        Add Manually
                      </button>
                    </div>
                  </div>
                ) : (
                  <table className="inventory-table">
                    <thead>
                      <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current</th>
                        <th>Min Par</th>
                        <th>Unit Cost</th>
                        <th>Total Value</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredInventory.map((item) => {
                        const status = getItemStatus(item);
                        const totalValue = _parseNumber(item.current) * _parseNumber(item.unitCost);

                        return (
                          <tr key={item.id}>
                            <td style={{fontWeight: 600}}>{item.name}</td>
                            <td style={{color: 'var(--text-secondary)'}}>{item.category}</td>
                            <td>
                              <span style={{fontFamily: 'JetBrains Mono', fontWeight: 600}}>
                                {_parseNumber(item.current)} {item.unit}
                              </span>
                            </td>
                            <td style={{color: 'var(--text-secondary)'}}>{_parseNumber(item.min)} {item.unit}</td>
                            <td style={{fontFamily: 'JetBrains Mono'}}>${_parseNumber(item.unitCost).toFixed(2)}</td>
                            <td style={{fontFamily: 'JetBrains Mono', fontWeight: 600}}>
                              ${totalValue.toFixed(2)}
                            </td>
                            <td>
                              <span className={`status-badge ${status}`}>
                                {status === 'critical' ? '🔴 Critical' :
                                 status === 'low' ? '🟡 Low' : '🟢 OK'}
                              </span>
                            </td>
                            <td>
                              <div style={{display: 'flex', gap: '8px'}}>
                                {status !== 'ok' && (
                                  <button
                                    className="btn btn-primary btn-small"
                                    onClick={() => quickOrder(item.id)}
                                  >
                                    Order
                                  </button>
                                )}
                                <button
                                  className="btn btn-secondary btn-small"
                                  onClick={() => setModalOpen({ type: 'edit-item', item })}
                                >
                                  Edit
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                )}
              </>
            ) : (
              <>
                <div style={{display: 'flex', gap: '10px', alignItems: 'center', marginBottom: '14px'}}>
                  <input
                    className="form-input"
                    placeholder="Search order guides (name/date/vendor)…"
                    value={guideFilter}
                    onChange={(e) => setGuideFilter(e.target.value)}
                    style={{flex: 1}}
                  />
                  <button className="btn btn-secondary" onClick={() => setGuideFilter('')}>Clear</button>
                </div>

                {filteredGuides.length === 0 ? (
                  <div className="empty-state">
                    <div className="empty-state-icon">🧾</div>
                    <h3>No order guides yet</h3>
                    <p>Create an order guide from your full inventory and it will be saved here each time.</p>
                    <button className="btn btn-primary" onClick={() => setModalOpen('order-guide')}>
                      Create Order Guide
                    </button>
                  </div>
                ) : (
                  <table className="inventory-table">
                    <thead>
                      <tr>
                        <th>Guide</th>
                        <th>Date</th>
                        <th>Items Ordered</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredGuides.map((g) => (
                        <tr key={g.id}>
                          <td style={{fontWeight: 700}}>{g.name || `Order Guide #${g.id}`}</td>
                          <td>{g.date ? new Date(g.date).toLocaleString() : '-'}</td>
                          <td>{orderedCount(g)} items</td>
                          <td style={{fontFamily: 'JetBrains Mono', fontWeight: 700}}>
                            ${_parseNumber(g.total).toFixed(2)}
                          </td>
                          <td>
                            <span className={`status-badge ${g.status === 'received' ? 'ok' : 'low'}`}>
                              {g.status || 'draft'}
                            </span>
                          </td>
                          <td>
                            <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                              <button
                                className="btn btn-secondary btn-small"
                                onClick={() => setModalOpen({ type: 'view-order-guide', guide: g })}
                              >
                                View
                              </button>
                              <button
                                className="btn btn-secondary btn-small"
                                onClick={() => _downloadCSV(`order_guide_${g.id}.csv`,
                                  (g.items || []).map(i => ({
                                    item: i.name,
                                    category: i.category || '',
                                    qty_total: _getGuideLineQty(i),
                                    unit: i.unit || '',
                                    supplier: i.supplier || '',
                                    unit_cost: i.unitCost || 0,
                                    est_total: (_parseNumber(_getGuideLineQty(i)) * _parseNumber(i.unitCost)).toFixed(2)
                                  }))
                                )}
                              >
                                Export
                              </button>
                              <button
                                className="btn btn-success btn-small"
                                disabled={!!g.appliedToInventory}
                                onClick={() => applyOrderGuideToInventory(g.id)}
                              >
                                {g.appliedToInventory ? 'Applied' : 'Apply to Inv.'}
                              </button>
                              <button
                                className="btn btn-danger btn-small"
                                onClick={() => deleteOrderGuide(g.id)}
                              >
                                Delete
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </>
            )}
          </div>
        );
      };


const Orders = () => {
        return (
          <div className="predictions-section">
            <div className="section-header">
              <div>
                <h2 className="section-title">Purchase Orders</h2>
                <p className="section-subtitle">Track all orders</p>
              </div>
              <button className="btn btn-primary" onClick={() => setModalOpen('smart-order')}>
                + New Order
              </button>
            </div>

            {orders.length === 0 ? (
              <div className="empty-state">
                <div className="empty-state-icon">📋</div>
                <h3>No orders yet</h3>
                <p>Create your first purchase order</p>
                <button className="btn btn-primary" onClick={() => setModalOpen('smart-order')}>
                  Create Order
                </button>
              </div>
            ) : (
              <table className="inventory-table">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map((order) => (
                    <tr key={order.id}>
                      <td style={{fontFamily: 'JetBrains Mono'}}>#{order.id}</td>
                      <td>{new Date(order.date).toLocaleDateString()}</td>
                      <td>{order.items.length} items</td>
                      <td style={{fontFamily: 'JetBrains Mono', fontWeight: 600}}>
                        ${order.total.toFixed(2)}
                      </td>
                      <td>
                        <span className={`status-badge ${order.status === 'delivered' ? 'ok' : 'low'}`}>
                          {order.status}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        );
      };

      const Recipes = () => {
        return (
          <div className="predictions-section">
            <div className="section-header">
              <div>
                <h2 className="section-title">Recipe Book</h2>
                <p className="section-subtitle">Your restaurant's recipes</p>
              </div>
              <button className="btn btn-primary" onClick={() => setModalOpen('add-recipe')}>
                + Add Recipe
              </button>
            </div>

            {recipes.length === 0 ? (
              <div className="empty-state">
                <div className="empty-state-icon">👨‍🍳</div>
                <h3>No recipes yet</h3>
                <p>Start building your digital recipe book</p>
                <button className="btn btn-primary" onClick={() => setModalOpen('add-recipe')}>
                  Add Your First Recipe
                </button>
              </div>
            ) : (
              <div className="recipe-grid">
                {recipes.map((recipe) => (
                  <div 
                    key={recipe.id} 
                    className="recipe-card"
                    onClick={() => setModalOpen({ type: 'view-recipe', recipe })}
                  >
                    <img 
                      src={recipe.image} 
                      alt={recipe.name}
                      className="recipe-image"
                      onError={(e) => {
                        e.target.src = 'https://via.placeholder.com/400x220/1a1a24/9ca3af?text=No+Image';
                      }}
                    />
                    <div className="recipe-content">
                      <div className="recipe-header">
                        <div>
                          <h3 className="recipe-title">{recipe.name}</h3>
                          <span className="recipe-category">{recipe.category}</span>
                        </div>
                      </div>
                      <div className="recipe-meta">
                        <div className="recipe-meta-item">
                          <span>⏱️</span>
                          <span>{recipe.prepTime + recipe.cookTime} min</span>
                        </div>
                        <div className="recipe-meta-item">
                          <span>🍽️</span>
                          <span>{recipe.servings} serving{recipe.servings > 1 ? 's' : ''}</span>
                        </div>
                        <div className="recipe-meta-item">
                          <span>📝</span>
                          <span>{recipe.ingredients.length} ingredients</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };


      const Banquets = () => {
        const [view, setView] = useState('events'); // events | menu
        const [search, setSearch] = useState('');
        const [rangeDays, setRangeDays] = useState(7);

        // Safety: protect against older saved data that isn't an array
        const eventsArr = Array.isArray(banquetEvents) ? banquetEvents : [];
        const menuArr = Array.isArray(banquetMenu) ? banquetMenu : [];

        const num = (v) => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return isFinite(v) ? v : 0;
          let s = String(v).trim();
          if (!s) return 0;
          s = s.replace(/\$/g,'').replace(/,/g,'');
          const paren = /^\((.*)\)$/.exec(s);
          if (paren) s = '-' + paren[1];
          const m = s.match(/-?\d+(\.\d+)?/);
          if (!m) return 0;
          const n = parseFloat(m[0]);
          return isFinite(n) ? n : 0;
        };

        const normalize = (s) => String(s ?? '').trim().toLowerCase();

        const parseDate = (s) => {
          if (!s) return null;
          const raw = String(s).trim();
          // accept YYYY-MM-DD or MM/DD/YYYY
          const iso = /^\d{4}-\d{2}-\d{2}/.test(raw) ? raw.slice(0,10) : null;
          if (iso) {
            const d = new Date(iso + "T00:00:00");
            return isNaN(d.getTime()) ? null : d;
          }
          const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
          if (m) {
            const mm = String(m[1]).padStart(2,'0');
            const dd = String(m[2]).padStart(2,'0');
            const yy = m[3].length===2 ? ('20'+m[3]) : m[3];
            const d = new Date(`${yy}-${mm}-${dd}T00:00:00`);
            return isNaN(d.getTime()) ? null : d;
          }
          const d = new Date(raw);
          return isNaN(d.getTime()) ? null : d;
        };

        const toISO = (d) => d.toISOString().slice(0,10);

        const saveEvents = async (next) => {
          setBanquetEvents(next);
          await StorageAPI.set('banquet-events', next);
          showToast('Banquet events saved');
        };

        const saveMenu = async (next) => {
          setBanquetMenu(next);
          await StorageAPI.set('banquet-menu', next);
          showToast('Banquet menu saved');
        };

        const addEventManual = async () => {
          const date = prompt("Event date (YYYY-MM-DD)?");
          if (!date) return;
          const name = prompt("Event name?");
          const guests = prompt("Guest count (pax)?");
          const notes = prompt("Notes (optional)?");
          const evt = {
            id: Date.now(),
            date: String(date).trim().slice(0,10),
            name: (name || '').trim(),
            guests: num(guests),
            notes: (notes || '').trim(),
            menuLines: []
          };
          const next = [evt, ...eventsArr];
          await saveEvents(next);
        };

        const importBEO = async (file) => {
          if (!file) return;
          try {
            const rows = await parseFile(file);
            const mapped = (rows || []).map((r, i) => {
              const date = String(
                r.date ?? r.Date ?? r['Event Date'] ?? r['EVENT DATE'] ?? r['Business Date'] ?? r['BEO Date'] ?? r['BEO DATE'] ?? ''
              ).trim();
              const name = String(
                r.name ?? r.Name ?? r.event ?? r.Event ?? r['Event Name'] ?? r['EVENT NAME'] ?? r['Function'] ?? r['FUNCTION'] ?? ''
              ).trim();
              const guests = num(
                r.guests ?? r.Guests ?? r.pax ?? r.Pax ?? r['Guest Count'] ?? r['GUEST COUNT'] ?? r['Attendees'] ?? r['ATTENDEES'] ?? 0
              );
              const notes = String(
                r.notes ?? r.Notes ?? r['Notes'] ?? r['Special Instructions'] ?? r['SPECIAL INSTRUCTIONS'] ?? ''
              ).trim();

              const d = parseDate(date);
              return {
                id: Date.now() + i,
                date: d ? toISO(d) : String(date).trim().slice(0,10),
                name,
                guests,
                notes,
                menuLines: [],
                raw: r
              };
            }).filter(x => x.date);

            // simple de-dupe by date+name+guests
            const key = (e) => `${e.date}__${normalize(e.name)}__${e.guests}`;
            const existing = new Map(eventsArr.map(e => [key(e), e]));
            mapped.forEach(e => {
              if (!existing.has(key(e))) existing.set(key(e), e);
            });

            const next = Array.from(existing.values()).sort((a,b) => (a.date||'').localeCompare(b.date||''));
            await saveEvents(next);
            showToast(`Imported ${mapped.length} BEO rows`);
          } catch (err) {
            console.error(err);
            alert("Could not import BEO file. Make sure it's a CSV/XLSX with a date column.");
          }
        };

        const filteredEvents = eventsArr
          .filter(e => {
            if (!search) return true;
            const s = normalize(search);
            return normalize(e.name).includes(s) || normalize(e.notes).includes(s) || normalize(e.date).includes(s);
          })
          .sort((a,b) => (a.date||'').localeCompare(b.date||''));

        const openEvent = (evt) => setModalOpen({ type: 'edit-beo', event: evt });

        const deleteEvent = async (evt) => {
          if (!confirm(`Delete event "${evt.name || evt.date}"?`)) return;
          const next = eventsArr.filter(e => e.id !== evt.id);
          await saveEvents(next);
        };

        const summary = (() => {
          // Next N days totals by menu item
          const days = Math.max(1, Math.min(30, Math.round(num(rangeDays) || 7)));
          const start = new Date();
          start.setHours(0,0,0,0);
          const end = new Date(start);
          end.setDate(start.getDate() + days);

          const map = new Map();
          eventsArr.forEach(evt => {
            const d = parseDate(evt.date);
            if (!d) return;
            if (d < start || d >= end) return;

            (evt.menuLines || []).forEach(line => {
              const mi = menuArr.find(m => m.id === line.menuItemId);
              const name = mi ? mi.name : '(Unknown menu item)';
              const entry = map.get(name) || { item: name, qty: 0, events: 0 };
              entry.qty += num(line.qty);
              entry.events += 1;
              map.set(name, entry);
            });
          });

          return Array.from(map.values()).sort((a,b)=> b.qty-a.qty);
        })();

        const addMenuItem = async () => {
          const name = prompt("Menu item name?");
          if (!name) return;
          const category = prompt("Category (e.g., Entree / Side / Dessert)?") || '';
          const unit = prompt("Unit (e.g., portions, pans, lbs)?") || 'portions';
          const perGuest = prompt("Default qty per guest? (usually 1)") || '1';
          const notes = prompt("Notes (optional)?") || '';
          const item = { id: Date.now(), name: name.trim(), category: category.trim(), unit: unit.trim(), perGuest: num(perGuest) || 1, notes: notes.trim() };
          const next = [item, ...menuArr];
          await saveMenu(next);
        };

        const deleteMenuItem = async (item) => {
          if (!confirm(`Delete menu item "${item.name}"?`)) return;
          const next = menuArr.filter(m => m.id !== item.id);
          // also remove from events
          const nextEvents = eventsArr.map(evt => ({
            ...evt,
            menuLines: (evt.menuLines || []).filter(l => l.menuItemId !== item.id)
          }));
          setBanquetEvents(nextEvents);
          await StorageAPI.set('banquet-events', nextEvents);
          await saveMenu(next);
        };

        return (
          <div>
            <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'16px'}}>
              <div>
                <h2 style={{margin:'0 0 4px'}}>Banquets</h2>
                <div style={{color:'var(--text-secondary)'}}>Upload BEOs, manage a banquet menu, and connect menu items to each event.</div>
              </div>
              <div style={{display:'flex', gap:'10px', flexWrap:'wrap'}}>
                <button className={`btn ${view==='events' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setView('events')}>BEO / Events</button>
                <button className={`btn ${view==='menu' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setView('menu')}>Banquet Menu</button>
              </div>
            </div>

            {view === 'events' && (
              <div>
                <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'12px'}}>
                  <button className="btn btn-secondary" onClick={addEventManual}>+ Add Event</button>
                  <label className="btn btn-secondary" style={{cursor:'pointer'}}>
                    Import BEO (CSV/XLSX)
                    <input type="file" accept=".csv,.xlsx,.xls" style={{display:'none'}} onChange={(e)=>importBEO(e.target.files?.[0])}/>
                  </label>
                  <input
                    placeholder="Search events..."
                    value={search}
                    onChange={(e)=>setSearch(e.target.value)}
                    style={{flex:'1', minWidth:'220px'}}
                  />
                </div>

                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px', marginBottom:'12px'}}>
                  <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'8px'}}>
                    <h3 style={{margin:0}}>Prep Summary (next</h3>
                    <div style={{display:'flex', gap:'8px', alignItems:'center'}}>
                      <span style={{color:'var(--text-secondary)'}}>days:</span>
                      <input value={rangeDays} onChange={(e)=>setRangeDays(e.target.value)} style={{width:'70px'}}/>
                    </div>
                  </div>
                  {summary.length === 0 ? (
                    <div style={{color:'var(--text-secondary)'}}>No menu assigned to upcoming events yet. Open an event and attach menu items.</div>
                  ) : (
                    <div style={{maxHeight:'220px', overflow:'auto'}}>
                      <table className="table" style={{width:'100%'}}>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>Menu Item</th>
                            <th style={{textAlign:'right'}}>Total Qty</th>
                            <th style={{textAlign:'right'}}>Event Lines</th>
                          </tr>
                        </thead>
                        <tbody>
                          {summary.map((s, idx) => (
                            <tr key={idx}>
                              <td>{s.item}</td>
                              <td style={{textAlign:'right'}}>{Math.round(s.qty*10)/10}</td>
                              <td style={{textAlign:'right'}}>{s.events}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
                  <h3 style={{margin:'0 0 10px'}}>Events</h3>
                  {filteredEvents.length === 0 ? (
                    <div style={{color:'var(--text-secondary)'}}>No events yet. Add one or import a BEO file.</div>
                  ) : (
                    <div style={{maxHeight:'420px', overflow:'auto'}}>
                      <table className="table" style={{width:'100%'}}>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>Date</th>
                            <th style={{textAlign:'left'}}>Event</th>
                            <th style={{textAlign:'right'}}>Guests</th>
                            <th style={{textAlign:'right'}}>Menu Items</th>
                            <th style={{textAlign:'right'}}>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredEvents.map((e) => (
                            <tr key={e.id}>
                              <td>{e.date}</td>
                              <td style={{cursor:'pointer'}} onClick={()=>openEvent(e)}>{e.name || '-'}</td>
                              <td style={{textAlign:'right'}}>{num(e.guests) || '-'}</td>
                              <td style={{textAlign:'right'}}>{(e.menuLines || []).length}</td>
                              <td style={{textAlign:'right'}}>
                                <button className="btn btn-secondary" onClick={()=>openEvent(e)}>Edit</button>{' '}
                                <button className="btn btn-secondary" onClick={()=>deleteEvent(e)}>Delete</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              </div>
            )}

            {view === 'menu' && (
              <div>
                <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'12px'}}>
                  <button className="btn btn-secondary" onClick={addMenuItem}>+ Add Menu Item</button>
                </div>

                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
                  <h3 style={{margin:'0 0 10px'}}>Banquet Menu Items</h3>
                  {(!banquetMenu || banquetMenu.length === 0) ? (
                    <div style={{color:'var(--text-secondary)'}}>No menu items yet. Add your banquet menu here.</div>
                  ) : (
                    <div style={{maxHeight:'480px', overflow:'auto'}}>
                      <table className="table" style={{width:'100%'}}>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>Item</th>
                            <th style={{textAlign:'left'}}>Category</th>
                            <th style={{textAlign:'right'}}>Default / Guest</th>
                            <th style={{textAlign:'left'}}>Unit</th>
                            <th style={{textAlign:'right'}}>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {menuArr.map((m) => (
                            <tr key={m.id}>
                              <td title={m.notes || ''}>{m.name}</td>
                              <td>{m.category || '-'}</td>
                              <td style={{textAlign:'right'}}>{num(m.perGuest) || 1}</td>
                              <td>{m.unit || 'portions'}</td>
                              <td style={{textAlign:'right'}}>
                                <button className="btn btn-secondary" onClick={()=>deleteMenuItem(m)}>Delete</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px', marginTop:'12px'}}>
                  <h3 style={{margin:'0 0 8px'}}>How the menu connects to BEOs</h3>
                  <div style={{color:'var(--text-secondary)'}}>
                    Open an event (Edit) and attach menu items with quantities (defaults to guests × default per-guest). The Prep Summary then totals everything needed for the upcoming days.
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      const EditBEOModal = ({ event }) => {
        const [draft, setDraft] = useState(event || null);
        const [selectedMenuId, setSelectedMenuId] = useState('');
        const [qty, setQty] = useState('');

        const eventsArrEB = Array.isArray(banquetEvents) ? banquetEvents : [];
        const menuArrEB = Array.isArray(banquetMenu) ? banquetMenu : [];

        const num = (v) => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return isFinite(v) ? v : 0;
          let s = String(v).trim();
          if (!s) return 0;
          s = s.replace(/\$/g,'').replace(/,/g,'');
          const m = s.match(/-?\d+(\.\d+)?/);
          if (!m) return 0;
          const n = parseFloat(m[0]);
          return isFinite(n) ? n : 0;
        };

        useEffect(() => {
          setDraft(event || null);
          setSelectedMenuId('');
          setQty('');
        }, [event]);

        if (!draft) return null;

        const save = async () => {
          const next = eventsArr.map(e => e.id === draft.id ? draft : e);
          setBanquetEvents(next);
          await StorageAPI.set('banquet-events', next);
          showToast('Event saved');
          setModalOpen(null);
        };

        const addLine = () => {
          const id = Number(selectedMenuId);
          if (!id) return;
          const item = menuArr.find(m => m.id === id);
          if (!item) return;
          const q = num(qty) || (num(draft.guests) * (num(item.perGuest) || 1));
          const line = { menuItemId: id, qty: q };
          const exists = (draft.menuLines || []).some(l => l.menuItemId === id);
          const lines = exists ? (draft.menuLines || []).map(l => l.menuItemId === id ? {...l, qty: q} : l) : [ ...(draft.menuLines || []), line ];
          setDraft({ ...draft, menuLines: lines });
          setSelectedMenuId('');
          setQty('');
        };

        const removeLine = (id) => {
          const lines = (draft.menuLines || []).filter(l => l.menuItemId !== id);
          setDraft({ ...draft, menuLines: lines });
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e)=>e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Edit BEO / Event</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div style={{display:'grid', gridTemplateColumns:'repeat(2, 1fr)', gap:'10px', marginBottom:'12px'}}>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Date</span>
                  <input value={draft.date || ''} onChange={(e)=>setDraft({...draft, date: e.target.value.slice(0,10)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Guests (pax)</span>
                  <input value={draft.guests ?? ''} onChange={(e)=>setDraft({...draft, guests: num(e.target.value)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px', gridColumn:'1 / span 2'}}>
                  <span style={{color:'var(--text-secondary)'}}>Event name</span>
                  <input value={draft.name || ''} onChange={(e)=>setDraft({...draft, name: e.target.value})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px', gridColumn:'1 / span 2'}}>
                  <span style={{color:'var(--text-secondary)'}}>Notes</span>
                  <input value={draft.notes || ''} onChange={(e)=>setDraft({...draft, notes: e.target.value})}/>
                </label>
              </div>

              <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px', marginBottom:'12px'}}>
                <h3 style={{margin:'0 0 10px'}}>Menu attached to this event</h3>

                {menuArr.length === 0 ? (
                  <div style={{color:'var(--text-secondary)'}}>Add banquet menu items first (Banquet Menu tab), then attach them here.</div>
                ) : (
                  <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'10px'}}>
                    <select value={selectedMenuId} onChange={(e)=>setSelectedMenuId(e.target.value)} style={{minWidth:'240px'}}>
                      <option value="">Select menu item…</option>
                      {menuArr.slice().sort((a,b)=>String(a.name).localeCompare(String(b.name))).map(m => (
                        <option key={m.id} value={m.id}>{m.name} {m.category ? `(${m.category})` : ''}</option>
                      ))}
                    </select>
                    <input placeholder="Qty (blank = auto)" value={qty} onChange={(e)=>setQty(e.target.value)} style={{width:'180px'}}/>
                    <button className="btn btn-secondary" onClick={addLine}>Add / Update</button>
                  </div>
                )}

                {(draft.menuLines || []).length === 0 ? (
                  <div style={{color:'var(--text-secondary)'}}>No menu items attached yet.</div>
                ) : (
                  <div style={{maxHeight:'240px', overflow:'auto'}}>
                    <table className="table" style={{width:'100%'}}>
                      <thead>
                        <tr>
                          <th style={{textAlign:'left'}}>Menu Item</th>
                          <th style={{textAlign:'right'}}>Qty</th>
                          <th style={{textAlign:'right'}}>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(draft.menuLines || []).map((l, idx) => {
                          const mi = menuArr.find(m => m.id === l.menuItemId);
                          return (
                            <tr key={idx}>
                              <td>{mi ? mi.name : '(Unknown)'}</td>
                              <td style={{textAlign:'right'}}>{Math.round(num(l.qty)*10)/10} {mi?.unit || ''}</td>
                              <td style={{textAlign:'right'}}>
                                <button className="btn btn-secondary" onClick={()=>removeLine(l.menuItemId)}>Remove</button>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <div style={{display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                <button className="btn btn-secondary" onClick={()=>setModalOpen(null)}>Cancel</button>
                <button className="btn btn-primary" onClick={save}>Save</button>
              </div>
            </div>
          </div>
        );
      };


      const Analytics = () => {
        const wastePatterns = AnalyticsEngine.analyzeWastePatterns(wasteData);
        
        return (
          <div className="predictions-section">
            <div className="section-header">
              <div>
                <h2 className="section-title">Analytics & Insights</h2>
                <p className="section-subtitle">Data-driven restaurant intelligence</p>
              </div>
            </div>

            {salesData.length === 0 && wasteData.length === 0 && laborData.length === 0 ? (
              <div className="empty-state">
                <div className="empty-state-icon">📊</div>
                <h3>No analytics data available</h3>
                <p>Upload your sales, waste, and labor data to see insights</p>
                <button className="btn btn-primary" onClick={() => setModalOpen('upload')}>
                  Upload Data
                </button>
              </div>
            ) : (
              <>
                <div className="stats-grid">
                  <div className="stat-card" style={{'--accent-color': '#3b82f6'}}>
                    <div className="stat-header">
                      <div className="stat-label">Sales Records</div>
                    </div>
                    <div className="stat-value">{salesData.length}</div>
                    <div className="stat-change">
                      Total revenue tracked
                    </div>
                  </div>

                  <div className="stat-card" style={{'--accent-color': '#ff4757'}}>
                    <div className="stat-header">
                      <div className="stat-label">Waste Events</div>
                    </div>
                    <div className="stat-value">{wasteData.length}</div>
                    <div className="stat-change">
                      Items wasted
                    </div>
                  </div>

                  <div className="stat-card" style={{'--accent-color': '#10b981'}}>
                    <div className="stat-header">
                      <div className="stat-label">Labor Entries</div>
                    </div>
                    <div className="stat-value">{laborData.length}</div>
                    <div className="stat-change">
                      Time records
                    </div>
                  </div>

                  <div className="stat-card" style={{'--accent-color': '#f59e0b'}}>
                    <div className="stat-header">
                      <div className="stat-label">Inventory Items</div>
                    </div>
                    <div className="stat-value">{inventory.length}</div>
                    <div className="stat-change">
                      Currently tracked
                    </div>
                  </div>
                </div>

                {wastePatterns.length > 0 && (
                  <div style={{marginTop: '20px'}}>
                    <h3 style={{marginBottom: '15px'}}>Top Waste Items</h3>
                    <table className="inventory-table">
                      <thead>
                        <tr>
                          <th>Item</th>
                          <th>Occurrences</th>
                          <th>Total Cost</th>
                        </tr>
                      </thead>
                      <tbody>
                        {wastePatterns.slice(0, 10).map((pattern, idx) => (
                          <tr key={idx}>
                            <td style={{fontWeight: 600}}>{pattern.item}</td>
                            <td>{pattern.occurrences}</td>
                            <td style={{fontFamily: 'JetBrains Mono', color: 'var(--accent-red)'}}>
                              ${pattern.totalCost.toFixed(2)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </>
            )}
          </div>
        );
      };

      // Modals
      const AddItemModal = () => {
        const [formData, setFormData] = useState({
          name: '',
          category: 'Protein',
          current: '',
          min: '',
          unit: 'lbs',
          unitCost: '',
          supplier: ''
        });

        const handleSubmit = (e) => {
          e.preventDefault();
          addInventoryItem({
            ...formData,
            current: parseFloat(formData.current),
            min: parseFloat(formData.min),
            unitCost: parseFloat(formData.unitCost)
          });
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Add Inventory Item</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>
              
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">Item Name</label>
                  <input 
                    type="text" 
                    className="form-input" 
                    required
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Category</label>
                  <select 
                    className="form-select"
                    value={formData.category}
                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                  >
                    <option>Protein</option>
                    <option>Produce</option>
                    <option>Dairy</option>
                    <option>Pantry</option>
                    <option>Beverages</option>
                  </select>
                </div>

                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                  <div className="form-group">
                    <label className="form-label">Current Quantity</label>
                    <input 
                      type="number" 
                      step="0.01"
                      className="form-input" 
                      required
                      value={formData.current}
                      onChange={(e) => setFormData({...formData, current: e.target.value})}
                    />
                  </div>

                  <div className="form-group">
                    <label className="form-label">Min Par Level</label>
                    <input 
                      type="number" 
                      step="0.01"
                      className="form-input" 
                      required
                      value={formData.min}
                      onChange={(e) => setFormData({...formData, min: e.target.value})}
                    />
                  </div>
                </div>

                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                  <div className="form-group">
                    <label className="form-label">Unit</label>
                    <select 
                      className="form-select"
                      value={formData.unit}
                      onChange={(e) => setFormData({...formData, unit: e.target.value})}
                    >
                      <option>lbs</option>
                      <option>oz</option>
                      <option>kg</option>
                      <option>gallons</option>
                      <option>quarts</option>
                      <option>pieces</option>
                      <option>heads</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Unit Cost ($)</label>
                    <input 
                      type="number" 
                      step="0.01"
                      className="form-input" 
                      required
                      value={formData.unitCost}
                      onChange={(e) => setFormData({...formData, unitCost: e.target.value})}
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Supplier</label>
                  <input 
                    type="text" 
                    className="form-input"
                    value={formData.supplier}
                    onChange={(e) => setFormData({...formData, supplier: e.target.value})}
                  />
                </div>

                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                  <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                    Add Item
                  </button>
                  <button 
                    type="button" 
                    className="btn btn-secondary"
                    onClick={() => setModalOpen(null)}
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const SmartOrderModal = () => {
        const lowStockItems = inventory.filter(item => item.current < item.min);
        const [selectedItems, setSelectedItems] = useState(
          lowStockItems.map(item => ({
            itemId: item.id,
            name: item.name,
            qty: item.min - item.current,
            unitCost: item.unitCost,
            supplier: item.supplier
          }))
        );

        const total = selectedItems.reduce((sum, item) => sum + (item.qty * item.unitCost), 0);

        const handleSubmit = (e) => {
          e.preventDefault();
          if (selectedItems.length === 0) {
            showToast('Please select at least one item', 'error');
            return;
          }
          createOrder(selectedItems);
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Smart Order</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              {lowStockItems.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-state-icon">✓</div>
                  <h3>All items are at par level!</h3>
                  <p>No items need to be ordered right now.</p>
                  <button className="btn btn-primary" onClick={() => setModalOpen(null)}>
                    Close
                  </button>
                </div>
              ) : (
                <form onSubmit={handleSubmit}>
                  <p style={{marginBottom: '20px', color: 'var(--text-secondary)'}}>
                    AI has identified {lowStockItems.length} items below par level
                  </p>

                  <table className="inventory-table" style={{marginBottom: '20px'}}>
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Needed</th>
                        <th>Cost</th>
                        <th>Supplier</th>
                      </tr>
                    </thead>
                    <tbody>
                      {selectedItems.map((item, idx) => (
                        <tr key={idx}>
                          <td style={{fontWeight: 600}}>{item.name}</td>
                          <td>{item.qty.toFixed(1)} units</td>
                          <td style={{fontFamily: 'JetBrains Mono'}}>
                            ${(item.qty * item.unitCost).toFixed(2)}
                          </td>
                          <td style={{color: 'var(--text-secondary)'}}>{item.supplier}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>

                  <div style={{
                    background: 'var(--bg-tertiary)', 
                    padding: '15px', 
                    borderRadius: '8px',
                    marginBottom: '20px'
                  }}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <span style={{fontWeight: 600}}>Order Total:</span>
                      <span style={{
                        fontSize: '24px', 
                        fontWeight: 800,
                        fontFamily: 'JetBrains Mono',
                        color: 'var(--accent-green)'
                      }}>
                        ${total.toFixed(2)}
                      </span>
                    </div>
                  </div>

                  <div style={{display: 'flex', gap: '10px'}}>
                    <button type="submit" className="btn btn-success" style={{flex: 1}}>
                      Create Order
                    </button>
                    <button 
                      type="button" 
                      className="btn btn-secondary"
                      onClick={() => setModalOpen(null)}
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              )}
            </div>
          </div>
        );
      };

      
      
      // Order Guide Modal (print-style / weekly grid like the paper guide)
      const OrderGuideModal = () => {
        const DAYS = [
          { key: 'sun', label: 'Sun' },
          { key: 'mon', label: 'Mon' },
          { key: 'tue', label: 'Tue' },
          { key: 'wed', label: 'Wed' },
          { key: 'thu', label: 'Thu' },
          { key: 'fri', label: 'Fri' },
        ];

        const todayISO = () => {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, '0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        };

        const [weekOf, setWeekOf] = useState(todayISO());
        const [notes, setNotes] = useState('');
        const [search, setSearch] = useState('');
        const [fillDay, setFillDay] = useState('mon');
        const [cutoff, setCutoff] = useState('11pm');

        const [lines, setLines] = useState(() =>
          (inventory || []).map(it => ({
            itemId: it.id,
            name: it.name,
            category: it.category || '',
            unit: it.unit || '',
            supplier: it.supplier || 'UNASSIGNED',
            current: _parseNumber(it.current),
            par: _parseNumber(it.min),
            unitCost: _parseNumber(it.unitCost),
            days: { sun: 0, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 }
          }))
        );

        const filtered = useMemo(() => {
          const f = search.trim().toLowerCase();
          if (!f) return lines;
          return lines.filter(l =>
            (l.name || '').toLowerCase().includes(f) ||
            (l.category || '').toLowerCase().includes(f) ||
            (l.supplier || '').toLowerCase().includes(f)
          );
        }, [lines, search]);

        const grouped = useMemo(() => {
          const bySupplier = {};
          filtered.forEach(l => {
            const s = (l.supplier || 'UNASSIGNED').trim() || 'UNASSIGNED';
            bySupplier[s] = bySupplier[s] || [];
            bySupplier[s].push(l);
          });
          Object.keys(bySupplier).forEach(s => {
            bySupplier[s].sort((a,b) => (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
          });
          return Object.entries(bySupplier).sort((a,b) => a[0].localeCompare(b[0]));
        }, [filtered]);

        const setDayQty = (itemId, dayKey, value) => {
          const v = value === '' ? '' : _parseNumber(value);
          setLines(prev => prev.map(l => {
            if (l.itemId !== itemId) return l;
            const days = { ...(l.days || {}) };
            days[dayKey] = v === '' ? '' : Math.max(0, v);
            return { ...l, days };
          }));
        };

        const recommendedFor = (l) => Math.max(0, _parseNumber(l.par) - _parseNumber(l.current));

        const fillRecommended = () => {
          setLines(prev => prev.map(l => {
            const days = { ...(l.days || {}) };
            days[fillDay] = recommendedFor(l);
            return { ...l, days };
          }));
        };

        const clearAll = () => {
          setLines(prev => prev.map(l => ({ ...l, days: { sun: 0, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 } })));
        };

        const totals = useMemo(() => {
          let orderedItems = 0;
          let total = 0;
          lines.forEach(l => {
            const qtyTotal = _sumDays(l.days);
            if (qtyTotal > 0) orderedItems++;
            total += qtyTotal * _parseNumber(l.unitCost);
          });
          return { orderedItems, total };
        }, [lines]);

        const exportDraft = () => {
          _downloadCSV(`order_guide_${Date.now()}.csv`, lines.map(l => {
            const qty_total = _sumDays(l.days);
            return ({
              week_of: weekOf,
              supplier: l.supplier,
              category: l.category,
              item: l.name,
              unit: l.unit,
              par: l.par,
              current: l.current,
              sun: l.days?.sun || 0,
              mon: l.days?.mon || 0,
              tue: l.days?.tue || 0,
              wed: l.days?.wed || 0,
              thu: l.days?.thu || 0,
              fri: l.days?.fri || 0,
              qty_total,
              unit_cost: l.unitCost,
              est_total: (qty_total * _parseNumber(l.unitCost)).toFixed(2)
            });
          }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const guide = {
            id: Date.now(),
            name: `ORDER GUIDE MARRAKESH RESTAURANT - week of ${weekOf}`,
            weekOf,
            cutoff,
            notes,
            date: new Date().toISOString(),
            status: 'draft',
            items: lines.map(l => ({
              itemId: l.itemId,
              name: l.name,
              category: l.category,
              unit: l.unit,
              supplier: l.supplier,
              unitCost: _parseNumber(l.unitCost),
              currentAtCreate: _parseNumber(l.current),
              parAtCreate: _parseNumber(l.par),
              days: { ...(l.days || { sun:0, mon:0, tue:0, wed:0, thu:0, fri:0 }) }
            })),
            total: totals.total
          };
          createOrderGuide(guide);
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '1100px'}}>
              <div className="modal-header">
                <h2 className="modal-title">Order Guide</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              {inventory.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-state-icon">📦</div>
                  <h3>No inventory items</h3>
                  <p>Add/import inventory first, then create order guides.</p>
                  <button className="btn btn-primary" onClick={() => setModalOpen(null)}>Close</button>
                </div>
              ) : (
                <form onSubmit={handleSubmit}>
                  <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'12px'}}>
                    <div style={{flex:'0 0 180px'}}>
                      <label className="form-label">Week of</label>
                      <input className="form-input" type="date" value={weekOf} onChange={(e)=>setWeekOf(e.target.value)} />
                    </div>
                    <div style={{flex:'0 0 140px'}}>
                      <label className="form-label">Cutoff</label>
                      <input className="form-input" value={cutoff} onChange={(e)=>setCutoff(e.target.value)} placeholder="e.g., 11pm" />
                    </div>
                    <div style={{flex:1, minWidth:'220px'}}>
                      <label className="form-label">Search</label>
                      <input className="form-input" value={search} onChange={(e)=>setSearch(e.target.value)} placeholder="Find items / categories / suppliers…" />
                    </div>
                  </div>

                  <div style={{display:'flex', gap:'10px', flexWrap:'wrap', alignItems:'end', marginBottom:'12px'}}>
                    <div style={{flex:'0 0 170px'}}>
                      <label className="form-label">Fill recommended into day</label>
                      <select className="form-select" value={fillDay} onChange={(e)=>setFillDay(e.target.value)}>
                        {DAYS.map(d => <option key={d.key} value={d.key}>{d.label}</option>)}
                      </select>
                    </div>
                    <button type="button" className="btn btn-secondary" onClick={fillRecommended}>
                      ⚡ Fill Recommended
                    </button>
                    <button type="button" className="btn btn-secondary" onClick={clearAll}>
                      🧽 Clear All
                    </button>
                    <button type="button" className="btn btn-secondary" onClick={exportDraft}>
                      ⬇️ Export CSV
                    </button>
                    <div style={{marginLeft:'auto', fontFamily:'JetBrains Mono', fontWeight:900, color:'var(--accent-green)'}}>
                      ${_parseNumber(totals.total).toFixed(2)} <span style={{color:'var(--text-secondary)', fontWeight:700}}>• {totals.orderedItems} items</span>
                    </div>
                  </div>

                  <div className="og-sheet">
                    <div className="og-header">
                      <div className="og-title">ORDER GUIDE MARRAKESH RESTAURANT</div>
                      <div className="og-week">week of&nbsp;&nbsp;<span style={{display:'inline-block', minWidth:'120px', borderBottom:'1px solid #111827'}}>&nbsp;{weekOf}&nbsp;</span></div>
                    </div>

                    <div className="og-two-col">
                      {grouped.map(([supplierName, items]) => (
                        <div className="og-block" key={supplierName}>
                          <div className="og-supplier">
                            <div>{supplierName} {cutoff ? <small>(cut off {cutoff})</small> : null}</div>
                          </div>
                          <table className="og-table">
                            <thead>
                              <tr>
                                <th rowSpan="2" className="og-item">Item name / supplier</th>
                                <th colSpan={DAYS.length} style={{textAlign:'center'}}>Day</th>
                                <th rowSpan="2" className="og-par">PAR</th>
                              </tr>
                              <tr>
                                {DAYS.map(d => <th key={d.key} className="og-day">{d.label}</th>)}
                              </tr>
                            </thead>
                            <tbody>
                              {items.map(l => (
                                <tr key={l.itemId}>
                                  <td className="og-item">
                                    {l.name}
                                    {l.category ? <div style={{fontSize:'10px', color:'#374151'}}>{l.category}</div> : null}
                                  </td>
                                  {DAYS.map(d => (
                                    <td key={d.key} className="og-day">
                                      <input
                                        className="og-input"
                                        inputMode="numeric"
                                        value={l.days?.[d.key] ?? 0}
                                        onChange={(e)=>setDayQty(l.itemId, d.key, e.target.value)}
                                        placeholder=""
                                      />
                                    </td>
                                  ))}
                                  <td className="og-par">{_parseNumber(l.par) || ''}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      ))}
                    </div>

                    <div className="og-notes">
                      <div className="og-notes-title">NOTE FOR SPECIAL ORDER</div>
                      <textarea value={notes} onChange={(e)=>setNotes(e.target.value)} placeholder="Notes, one-offs, special items…"></textarea>
                    </div>
                  </div>

                  <div className="og-actions">
                    <button type="button" className="btn btn-secondary" onClick={() => window.print()}>
                      🖨️ Print
                    </button>
                    <button type="button" className="btn btn-secondary" onClick={() => setModalOpen(null)}>
                      Cancel
                    </button>
                    <button type="submit" className="btn btn-primary">
                      Save Order Guide
                    </button>
                  </div>
                </form>
              )}
            </div>
          </div>
        );
      };


      const ViewOrderGuideModal = ({ guide }) => {
        const DAYS = [
          { key: 'sun', label: 'Sun' },
          { key: 'mon', label: 'Mon' },
          { key: 'tue', label: 'Tue' },
          { key: 'wed', label: 'Wed' },
          { key: 'thu', label: 'Thu' },
          { key: 'fri', label: 'Fri' },
        ];

        const [onlyOrdered, setOnlyOrdered] = useState(true);
        const [search, setSearch] = useState('');

        const hasDays = useMemo(() => (guide?.items || []).some(i => !!i.days), [guide]);

        const rows = useMemo(() => {
          const f = search.trim().toLowerCase();
          return (guide?.items || []).filter(i => {
            const qtyTotal = _getGuideLineQty(i);
            if (onlyOrdered && qtyTotal <= 0) return false;
            if (!f) return true;
            return (i.name || '').toLowerCase().includes(f) ||
                   (i.category || '').toLowerCase().includes(f) ||
                   (i.supplier || '').toLowerCase().includes(f);
          }).map(i => ({...i, qty_total: _getGuideLineQty(i)}));
        }, [guide, onlyOrdered, search]);

        const grouped = useMemo(() => {
          const bySupplier = {};
          rows.forEach(r => {
            const s = (r.supplier || 'UNASSIGNED').trim() || 'UNASSIGNED';
            bySupplier[s] = bySupplier[s] || [];
            bySupplier[s].push(r);
          });
          Object.keys(bySupplier).forEach(s => {
            bySupplier[s].sort((a,b) => (a.category||'').localeCompare(b.category||'') || (a.name||'').localeCompare(b.name||''));
          });
          return Object.entries(bySupplier).sort((a,b) => a[0].localeCompare(b[0]));
        }, [rows]);

        const exportGuide = () => {
          _downloadCSV(`order_guide_${guide?.id}.csv`, (guide?.items || []).map(i => {
            const qty_total = _getGuideLineQty(i);
            return ({
              guide_id: guide?.id,
              week_of: guide?.weekOf || '',
              supplier: i.supplier || '',
              category: i.category || '',
              item: i.name,
              unit: i.unit || '',
              par: i.parAtCreate ?? i.minAtCreate ?? i.par ?? '',
              sun: i.days?.sun || 0,
              mon: i.days?.mon || 0,
              tue: i.days?.tue || 0,
              wed: i.days?.wed || 0,
              thu: i.days?.thu || 0,
              fri: i.days?.fri || 0,
              qty_total,
              unit_cost: i.unitCost || 0,
              est_total: (qty_total * _parseNumber(i.unitCost)).toFixed(2)
            });
          }));
        };

        // Legacy view for older guides (no day grid)
        if (!hasDays) {
          const items = rows;
          return (
            <div className="modal-overlay" onClick={() => setModalOpen(null)}>
              <div className="modal" onClick={(e)=>e.stopPropagation()} style={{maxWidth:'980px'}}>
                <div className="modal-header">
                  <h2 className="modal-title">{guide?.name || 'Order Guide'}</h2>
                  <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
                </div>

                <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'14px'}}>
                  <div style={{flex:1, minWidth:'240px'}}>
                    <input className="form-input" placeholder="Search items…" value={search} onChange={(e)=>setSearch(e.target.value)} />
                  </div>
                  <button className="btn btn-secondary" onClick={()=>setOnlyOrdered(v=>!v)}>
                    {onlyOrdered ? 'Show All Items' : 'Show Only Ordered'}
                  </button>
                  <button className="btn btn-secondary" onClick={exportGuide}>Export CSV</button>
                  <button className="btn btn-success" disabled={!!guide?.appliedToInventory} onClick={() => applyOrderGuideToInventory(guide.id)}>
                    {guide?.appliedToInventory ? 'Applied to Inventory' : 'Apply to Inventory'}
                  </button>
                </div>

                <div style={{maxHeight:'480px', overflow:'auto', borderRadius:'12px'}}>
                  <table className="inventory-table">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Supplier</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Unit Cost</th>
                        <th>Est.</th>
                      </tr>
                    </thead>
                    <tbody>
                      {items.map((i, idx) => (
                        <tr key={idx}>
                          <td style={{fontWeight:750}}>
                            {i.name}
                            <div style={{color:'var(--text-secondary)', fontSize:'12px'}}>{i.category || ''}</div>
                          </td>
                          <td style={{color:'var(--text-secondary)'}}>{i.supplier || ''}</td>
                          <td style={{fontFamily:'JetBrains Mono', fontWeight:800}}>{_parseNumber(i.qty_total)}</td>
                          <td style={{color:'var(--text-secondary)'}}>{i.unit || ''}</td>
                          <td style={{fontFamily:'JetBrains Mono'}}>${_parseNumber(i.unitCost).toFixed(2)}</td>
                          <td style={{fontFamily:'JetBrains Mono', fontWeight:900}}>
                            ${( _parseNumber(i.qty_total) * _parseNumber(i.unitCost)).toFixed(2)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="og-actions">
                  <button type="button" className="btn btn-secondary" onClick={() => setModalOpen(null)}>Close</button>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e)=>e.stopPropagation()} style={{maxWidth:'1100px'}}>
              <div className="modal-header">
                <h2 className="modal-title">{guide?.name || 'Order Guide'}</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div style={{display:'flex', gap:'10px', flexWrap:'wrap', alignItems:'end', marginBottom:'12px'}}>
                <div style={{flex:1, minWidth:'240px'}}>
                  <label className="form-label">Search</label>
                  <input className="form-input" placeholder="Search items…" value={search} onChange={(e)=>setSearch(e.target.value)} />
                </div>
                <button className="btn btn-secondary" onClick={()=>setOnlyOrdered(v=>!v)}>
                  {onlyOrdered ? 'Show All Items' : 'Show Only Ordered'}
                </button>
                <button className="btn btn-secondary" onClick={exportGuide}>⬇️ Export CSV</button>
                <button className="btn btn-secondary" onClick={() => window.print()}>🖨️ Print</button>
                <button className="btn btn-success" disabled={!!guide?.appliedToInventory} onClick={() => applyOrderGuideToInventory(guide.id)}>
                  {guide?.appliedToInventory ? 'Applied' : 'Apply to Inv.'}
                </button>
              </div>

              <div className="og-sheet">
                <div className="og-header">
                  <div className="og-title">ORDER GUIDE MARRAKESH RESTAURANT</div>
                  <div className="og-week">week of&nbsp;&nbsp;<span style={{display:'inline-block', minWidth:'120px', borderBottom:'1px solid #111827'}}>&nbsp;{guide?.weekOf || ''}&nbsp;</span></div>
                </div>

                <div className="og-two-col">
                  {grouped.map(([supplierName, items]) => (
                    <div className="og-block" key={supplierName}>
                      <div className="og-supplier">
                        <div>{supplierName} {guide?.cutoff ? <small>(cut off {guide.cutoff})</small> : null}</div>
                      </div>
                      <table className="og-table">
                        <thead>
                          <tr>
                            <th rowSpan="2" className="og-item">Item name / supplier</th>
                            <th colSpan={DAYS.length} style={{textAlign:'center'}}>Day</th>
                            <th rowSpan="2" className="og-par">PAR</th>
                          </tr>
                          <tr>
                            {DAYS.map(d => <th key={d.key} className="og-day">{d.label}</th>)}
                          </tr>
                        </thead>
                        <tbody>
                          {items.map(l => (
                            <tr key={l.itemId}>
                              <td className="og-item">
                                {l.name}
                                {l.category ? <div style={{fontSize:'10px', color:'#374151'}}>{l.category}</div> : null}
                              </td>
                              {DAYS.map(d => (
                                <td key={d.key} className="og-day">
                                  <div style={{fontWeight:900}}>{_parseNumber(l.days?.[d.key] || 0) || ''}</div>
                                </td>
                              ))}
                              <td className="og-par">{_parseNumber(l.parAtCreate ?? l.minAtCreate ?? 0) || ''}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ))}
                </div>

                <div className="og-notes">
                  <div className="og-notes-title">NOTE FOR SPECIAL ORDER</div>
                  <textarea value={guide?.notes || ''} readOnly />
                </div>
              </div>

              <div className="og-actions">
                <button type="button" className="btn btn-secondary" onClick={() => setModalOpen(null)}>Close</button>
              </div>
            </div>
          </div>
        );
      };

const AddRecipeModal = () => {
        const [formData, setFormData] = useState({
          name: '',
          category: 'Entree',
          prepTime: '',
          cookTime: '',
          servings: '',
          image: '',
          ingredients: [{ item: '', quantity: '', unit: 'oz' }],
          instructions: [''],
          notes: ''
        });

        const handleSubmit = (e) => {
          e.preventDefault();
          addRecipe({
            ...formData,
            prepTime: parseInt(formData.prepTime),
            cookTime: parseInt(formData.cookTime),
            servings: parseInt(formData.servings),
          });
        };

        const addIngredient = () => {
          setFormData({
            ...formData,
            ingredients: [...formData.ingredients, { item: '', quantity: '', unit: 'oz' }]
          });
        };

        const updateIngredient = (index, field, value) => {
          const newIngredients = [...formData.ingredients];
          newIngredients[index][field] = value;
          setFormData({ ...formData, ingredients: newIngredients });
        };

        const removeIngredient = (index) => {
          const newIngredients = formData.ingredients.filter((_, i) => i !== index);
          setFormData({ ...formData, ingredients: newIngredients });
        };

        const addInstruction = () => {
          setFormData({
            ...formData,
            instructions: [...formData.instructions, '']
          });
        };

        const updateInstruction = (index, value) => {
          const newInstructions = [...formData.instructions];
          newInstructions[index] = value;
          setFormData({ ...formData, instructions: newInstructions });
        };

        const removeInstruction = (index) => {
          const newInstructions = formData.instructions.filter((_, i) => i !== index);
          setFormData({ ...formData, instructions: newInstructions });
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
              <div className="modal-header">
                <h2 className="modal-title">Add New Recipe</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>
              
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">Recipe Name</label>
                  <input 
                    type="text" 
                    className="form-input" 
                    required
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                  />
                </div>

                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                  <div className="form-group">
                    <label className="form-label">Category</label>
                    <select 
                      className="form-select"
                      value={formData.category}
                      onChange={(e) => setFormData({...formData, category: e.target.value})}
                    >
                      <option>Appetizer</option>
                      <option>Entree</option>
                      <option>Side</option>
                      <option>Dessert</option>
                      <option>Sauce</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Servings</label>
                    <input 
                      type="number" 
                      className="form-input" 
                      required
                      value={formData.servings}
                      onChange={(e) => setFormData({...formData, servings: e.target.value})}
                    />
                  </div>
                </div>

                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                  <div className="form-group">
                    <label className="form-label">Prep Time (min)</label>
                    <input 
                      type="number" 
                      className="form-input" 
                      required
                      value={formData.prepTime}
                      onChange={(e) => setFormData({...formData, prepTime: e.target.value})}
                    />
                  </div>

                  <div className="form-group">
                    <label className="form-label">Cook Time (min)</label>
                    <input 
                      type="number" 
                      className="form-input" 
                      required
                      value={formData.cookTime}
                      onChange={(e) => setFormData({...formData, cookTime: e.target.value})}
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Image URL</label>
                  <input 
                    type="text" 
                    className="form-input"
                    placeholder="https://example.com/image.jpg"
                    value={formData.image}
                    onChange={(e) => setFormData({...formData, image: e.target.value})}
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Ingredients</label>
                  {formData.ingredients.map((ingredient, idx) => (
                    <div key={idx} style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                      <input 
                        type="text" 
                        className="form-input"
                        placeholder="Item"
                        style={{flex: 2}}
                        value={ingredient.item}
                        onChange={(e) => updateIngredient(idx, 'item', e.target.value)}
                        required
                      />
                      <input 
                        type="number" 
                        step="0.01"
                        className="form-input"
                        placeholder="Qty"
                        style={{flex: 1}}
                        value={ingredient.quantity}
                        onChange={(e) => updateIngredient(idx, 'quantity', e.target.value)}
                        required
                      />
                      <select 
                        className="form-select"
                        style={{flex: 1}}
                        value={ingredient.unit}
                        onChange={(e) => updateIngredient(idx, 'unit', e.target.value)}
                      >
                        <option>oz</option>
                        <option>lbs</option>
                        <option>g</option>
                        <option>kg</option>
                        <option>tsp</option>
                        <option>tbsp</option>
                        <option>cup</option>
                        <option>whole</option>
                        <option>cloves</option>
                      </select>
                      {formData.ingredients.length > 1 && (
                        <button 
                          type="button"
                          className="btn btn-secondary btn-small"
                          onClick={() => removeIngredient(idx)}
                        >
                          ×
                        </button>
                      )}
                    </div>
                  ))}
                  <button 
                    type="button" 
                    className="btn btn-secondary btn-small"
                    onClick={addIngredient}
                  >
                    + Add Ingredient
                  </button>
                </div>

                <div className="form-group">
                  <label className="form-label">Instructions</label>
                  {formData.instructions.map((instruction, idx) => (
                    <div key={idx} style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                      <textarea 
                        className="form-input"
                        rows="2"
                        placeholder={`Step ${idx + 1}`}
                        value={instruction}
                        onChange={(e) => updateInstruction(idx, e.target.value)}
                        required
                        style={{flex: 1}}
                      />
                      {formData.instructions.length > 1 && (
                        <button 
                          type="button"
                          className="btn btn-secondary btn-small"
                          onClick={() => removeInstruction(idx)}
                        >
                          ×
                        </button>
                      )}
                    </div>
                  ))}
                  <button 
                    type="button" 
                    className="btn btn-secondary btn-small"
                    onClick={addInstruction}
                  >
                    + Add Step
                  </button>
                </div>

                <div className="form-group">
                  <label className="form-label">Chef Notes (optional)</label>
                  <textarea 
                    className="form-input"
                    rows="3"
                    value={formData.notes}
                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                  />
                </div>

                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                  <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                    Add Recipe
                  </button>
                  <button 
                    type="button" 
                    className="btn btn-secondary"
                    onClick={() => setModalOpen(null)}
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const ViewRecipeModal = ({ recipe }) => {
        return (
          <div className="modal-overlay recipe-detail-modal" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Recipe Details</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div className="recipe-detail-header">
                <img 
                  src={recipe.image} 
                  alt={recipe.name}
                  className="recipe-detail-image"
                  onError={(e) => {
                    e.target.src = 'https://via.placeholder.com/300/1a1a24/9ca3af?text=No+Image';
                  }}
                />
                <div className="recipe-detail-info">
                  <h2 className="recipe-detail-title">{recipe.name}</h2>
                  <span className="recipe-category">{recipe.category}</span>
                  
                  <div className="recipe-detail-meta">
                    <div className="recipe-detail-meta-item">
                      <span>⏱️</span>
                      <span>Prep: {recipe.prepTime} min</span>
                    </div>
                    <div className="recipe-detail-meta-item">
                      <span>🔥</span>
                      <span>Cook: {recipe.cookTime} min</span>
                    </div>
                    <div className="recipe-detail-meta-item">
                      <span>🍽️</span>
                      <span>{recipe.servings} servings</span>
                    </div>
                  </div>

                  {recipe.notes && (
                    <div className="recipe-notes" style={{marginTop: '15px'}}>
                      <strong>Chef's Notes:</strong> {recipe.notes}
                    </div>
                  )}
                </div>
              </div>

              <div className="recipe-section">
                <h3 className="recipe-section-title">
                  <span>📋</span>
                  <span>Ingredients</span>
                </h3>
                <ul className="ingredients-list">
                  {recipe.ingredients.map((ingredient, idx) => (
                    <li key={idx} className="ingredient-item">
                      <span className="ingredient-quantity">
                        {ingredient.quantity} {ingredient.unit}
                      </span>
                      <span>{ingredient.item}</span>
                    </li>
                  ))}
                </ul>
              </div>

              <div className="recipe-section">
                <h3 className="recipe-section-title">
                  <span>👨‍🍳</span>
                  <span>Instructions</span>
                </h3>
                <ol className="instructions-list">
                  {recipe.instructions.map((instruction, idx) => (
                    <li key={idx} className="instruction-item">
                      {instruction}
                    </li>
                  ))}
                </ol>
              </div>

              <div style={{display: 'flex', gap: '10px', marginTop: '30px'}}>
                <button 
                  className="btn btn-warning"
                  onClick={() => {
                    deleteRecipe(recipe.id);
                    setModalOpen(null);
                  }}
                >
                  Delete Recipe
                </button>
                <button 
                  className="btn btn-secondary"
                  style={{flex: 1}}
                  onClick={() => setModalOpen(null)}
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      };

      const EditItemModal = ({ item }) => {
        const [formData, setFormData] = useState({
          current: item.current,
          min: item.min,
          unitCost: item.unitCost
        });

        const handleSubmit = (e) => {
          e.preventDefault();
          updateInventoryItem(item.id, {
            current: parseFloat(formData.current),
            min: parseFloat(formData.min),
            unitCost: parseFloat(formData.unitCost)
          });
          setModalOpen(null);
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Edit {item.name}</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>
              
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label className="form-label">Current Quantity</label>
                  <input 
                    type="number" 
                    step="0.01"
                    className="form-input" 
                    required
                    value={formData.current}
                    onChange={(e) => setFormData({...formData, current: e.target.value})}
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Min Par Level</label>
                  <input 
                    type="number" 
                    step="0.01"
                    className="form-input" 
                    required
                    value={formData.min}
                    onChange={(e) => setFormData({...formData, min: e.target.value})}
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Unit Cost ($)</label>
                  <input 
                    type="number" 
                    step="0.01"
                    className="form-input" 
                    required
                    value={formData.unitCost}
                    onChange={(e) => setFormData({...formData, unitCost: e.target.value})}
                  />
                </div>

                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                  <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                    Update Item
                  </button>
                  <button 
                    type="button" 
                    className="btn btn-warning"
                    onClick={() => {
                      deleteInventoryItem(item.id);
                      setModalOpen(null);
                    }}
                  >
                    Delete
                  </button>
                  <button 
                    type="button" 
                    className="btn btn-secondary"
                    onClick={() => setModalOpen(null)}
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      if (loading) {
        return (
          <div className="app-container" style={{
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            minHeight: '100vh'
          }}>
            <div style={{textAlign: 'center'}}>
              <div className="loading" style={{
                width: '48px',
                height: '48px',
                borderWidth: '4px',
                margin: '0 auto 20px'
              }}></div>
              <p style={{color: 'var(--text-secondary)'}}>Loading Chef Ops AI...</p>
            </div>
          </div>
        );
      }


      // --- NEW: Waste drill-down (Dashboard -> Waste) ---
      const WasteModal = () => {
        const num = (v) => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return isFinite(v) ? v : 0;
          const s0 = String(v).trim();
          if (!s0) return 0;
          let s = s0.replace(/\$/g, '').replace(/,/g, '');
          const paren = /^\((.*)\)$/.exec(s);
          if (paren) s = '-' + paren[1];
          const m = s.match(/-?\d+(\.\d+)?/);
          if (!m) return 0;
          const n = parseFloat(m[0]);
          return isFinite(n) ? n : 0;
        };

        const getRevenue = (row) => num(
          row.revenue ?? row.Revenue ?? row.sales ?? row.Sales ?? row.total ?? row.Total ??
          row.netSales ?? row.NetSales ?? row.net_sales ?? row.NET_SALES ??
          row['Net Sales'] ?? row['NET SALES'] ?? row['Total Sales'] ?? row['TOTAL SALES'] ??
          row.amount ?? row.Amount ?? 0
        );

        const getCost = (row) => {
          // waste cost (most common)
          let c = num(
            row.wasteCost ?? row.WasteCost ?? row.waste_cost ?? row['Waste Cost'] ?? row['WASTE COST'] ??
            row.cost ?? row.Cost ?? row.amount ?? row.Amount ?? 0
          );

          // If waste cost missing but qty + unit cost exist, approximate: qty * unitCost
          if (!c) {
            const q = num(row.qty ?? row.Qty ?? row.quantity ?? row.Quantity ?? row['Qty'] ?? row['Quantity'] ?? 0);
            const uc = num(
              row.unitCost ?? row.UnitCost ?? row.unit_cost ?? row['Unit Cost'] ?? row['UNIT COST'] ??
              row.price ?? row.Price ?? 0
            );
            if (q > 0 && uc > 0) c = q * uc;
          }
          return c;
        };

        const getQty = (row) => num(
          row.qty ?? row.Qty ?? row.quantity ?? row.Quantity ?? row['Qty'] ?? row['Quantity'] ?? 0
        );

        const getUnit = (row) => String(
          row.unit ?? row.Unit ?? row.uom ?? row.UOM ?? row['UOM'] ?? row['Unit'] ?? ''
        ).trim();

        const getItem = (row) => String(
          row.item ?? row.Item ?? row.name ?? row.Name ?? row.product ?? row.Product ?? row.description ?? row.Description ??
          row['Item Name'] ?? row['ITEM NAME'] ?? ''
        ).trim() || '(Unnamed)';

        const getDate = (row) => String(
          row.date ?? row.Date ?? row.day ?? row.Day ??
          row['Business Date'] ?? row['BUSINESS DATE'] ??
          row['Waste Date'] ?? row['WASTE DATE'] ??
          row['Date'] ?? ''
        ).trim();

        const getReason = (row) => String(
          row.reason ?? row.Reason ?? row.notes ?? row.Notes ?? row.comment ?? row.Comment ??
          row['Reason'] ?? row['Notes'] ?? ''
        ).trim();

        // Totals
        let totalWasteCost = 0;
        let totalWasteQty = 0;

        (wasteData || []).forEach(r => {
          totalWasteCost += getCost(r);
          totalWasteQty += getQty(r);
        });

        let totalSales = 0;
        (salesData || []).forEach(r => { totalSales += getRevenue(r); });

        const wastePct = totalSales > 0 ? ((totalWasteCost / totalSales) * 100) : null;

        // Group by item
        const itemMap = new Map();
        (wasteData || []).forEach(r => {
          const key = getItem(r);
          const entry = itemMap.get(key) || { item: key, cost: 0, qty: 0, count: 0 };
          entry.cost += getCost(r);
          entry.qty += getQty(r);
          entry.count += 1;
          itemMap.set(key, entry);
        });

        const topItems = Array.from(itemMap.values())
          .sort((a,b) => (b.cost - a.cost) || (b.count - a.count))
          .slice(0, 12);

        const recent = (wasteData || []).slice(0, 80);

        const fmtMoney = (n) => {
          const v = num(n);
          return '$' + v.toFixed(2);
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Waste Details</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div style={{display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:'12px', marginBottom:'16px'}}>
                <div className="stat-card" style={{'--accent-color':'#ff4757'}}>
                  <div className="stat-header">
                    <div className="stat-label">Total Waste Cost</div>
                  </div>
                  <div className="stat-value">{fmtMoney(totalWasteCost)}</div>
                  <div className="stat-change negative">{(wasteData || []).length} records</div>
                </div>

                <div className="stat-card" style={{'--accent-color':'#3b82f6'}}>
                  <div className="stat-header">
                    <div className="stat-label">Waste % of Sales</div>
                  </div>
                  <div className="stat-value">
                    {wastePct === null ? '-' : (wastePct.toFixed(2) + '%')}
                  </div>
                  <div className="stat-change positive">
                    {totalSales > 0 ? `Sales: ${fmtMoney(totalSales)}` : 'Upload sales to calculate %'}
                  </div>
                </div>

                <div className="stat-card" style={{'--accent-color':'#10b981'}}>
                  <div className="stat-header">
                    <div className="stat-label">Total Waste Qty</div>
                  </div>
                  <div className="stat-value">{Math.round(totalWasteQty)}</div>
                  <div className="stat-change positive">Across all waste logs</div>
                </div>
              </div>

              <div style={{marginBottom:'14px', color:'var(--text-secondary)'}}>
                <strong>How this is calculated:</strong> Total waste is the sum of your waste log “cost” (or qty × unit cost when cost is missing). Waste % is Total Waste ÷ Total Sales.
              </div>

              <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'14px'}}>
                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
                  <h3 style={{margin:'0 0 10px'}}>Top Waste Items</h3>
                  {topItems.length === 0 ? (
                    <div style={{color:'var(--text-secondary)'}}>No waste data uploaded yet.</div>
                  ) : (
                    <div style={{maxHeight:'320px', overflow:'auto'}}>
                      <table className="table" style={{width:'100%'}}>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>Item</th>
                            <th style={{textAlign:'right'}}>Cost</th>
                            <th style={{textAlign:'right'}}>Count</th>
                          </tr>
                        </thead>
                        <tbody>
                          {topItems.map((x, idx) => (
                            <tr key={idx}>
                              <td>{x.item}</td>
                              <td style={{textAlign:'right'}}>{fmtMoney(x.cost)}</td>
                              <td style={{textAlign:'right'}}>{x.count}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

                <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
                  <h3 style={{margin:'0 0 10px'}}>Recent Waste Entries</h3>
                  {recent.length === 0 ? (
                    <div style={{color:'var(--text-secondary)'}}>Upload a waste CSV to see details.</div>
                  ) : (
                    <div style={{maxHeight:'320px', overflow:'auto'}}>
                      <table className="table" style={{width:'100%'}}>
                        <thead>
                          <tr>
                            <th style={{textAlign:'left'}}>Date</th>
                            <th style={{textAlign:'left'}}>Item</th>
                            <th style={{textAlign:'right'}}>Qty</th>
                            <th style={{textAlign:'right'}}>Cost</th>
                          </tr>
                        </thead>
                        <tbody>
                          {recent.map((r, idx) => (
                            <tr key={idx}>
                              <td>{getDate(r)}</td>
                              <td title={getReason(r)}>{getItem(r)}</td>
                              <td style={{textAlign:'right'}}>{getQty(r)} {getUnit(r)}</td>
                              <td style={{textAlign:'right'}}>{fmtMoney(getCost(r))}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              </div>

              <div style={{display:'flex', justifyContent:'flex-end', gap:'10px', marginTop:'16px'}}>
                <button className="btn btn-secondary" onClick={() => setModalOpen(null)}>Close</button>
              </div>
            </div>
          </div>
        );
      };



      // --- NEW: Labor drill-down + Scheduling (Dashboard -> Labor) ---
      const LaborModal = () => {
        const [tab, setTab] = useState('overview'); // overview | scheduling | history | settings
        const [employees, setEmployees] = useState([]);
        const [events, setEvents] = useState([]); // upcoming banquets/events
        const [plans, setPlans] = useState([]);   // saved schedules
        const [settings, setSettings] = useState({
          shiftLengthHours: 8,
          maxWeeklyHours: 40,
          baseHoursPerDay: 8,          // baseline banquet coverage even with no events
          hoursPerGuest: 0.06,         // 0.06 = 6 labor hours per 100 guests (tune this)
          fixedSetupHours: 4,
          fixedCleanupHours: 3,
          horizonDays: 14,
          treatAllLaborAsBanquet: true
        });

        const num = (v) => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return isFinite(v) ? v : 0;
          let s = String(v).trim();
          if (!s) return 0;
          s = s.replace(/\$/g,'').replace(/,/g,'');
          const paren = /^\((.*)\)$/.exec(s);
          if (paren) s = '-' + paren[1];
          const m = s.match(/-?\d+(\.\d+)?/);
          if (!m) return 0;
          const n = parseFloat(m[0]);
          return isFinite(n) ? n : 0;
        };

        const normalize = (s) => String(s ?? '').trim().toLowerCase();

        const getDate = (row) => {
          const d = row.date ?? row.Date ?? row.day ?? row.Day ?? row['Business Date'] ?? row['BUSINESS DATE'] ?? row['Date'] ?? '';
          return String(d ?? '').trim();
        };

        const getHours = (row) => num(row.hours ?? row.Hours ?? row.hrs ?? row.Hrs ?? row['Hours'] ?? row['HOURS'] ?? 0);
        const getRate  = (row) => num(row.rate ?? row.Rate ?? row.wage ?? row.Wage ?? row['Rate'] ?? row['Wage'] ?? 0);
        const getCost  = (row) => {
          const c = num(row.cost ?? row.Cost ?? row.laborCost ?? row.LaborCost ?? row['Labor Cost'] ?? row['LABOR COST'] ?? 0);
          if (c) return c;
          const h = getHours(row);
          const r = getRate(row);
          return (h && r) ? (h * r) : 0;
        };

        const getEmployee = (row) => {
          const e = row.employee ?? row.Employee ?? row.name ?? row.Name ?? row['Employee'] ?? row['Name'] ?? '';
          return String(e ?? '').trim();
        };

        const getDept = (row) => String(
          row.department ?? row.Department ?? row.dept ?? row.Dept ?? row.team ?? row.Team ?? row.role ?? row.Role ?? ''
        ).trim();

        const looksBanquet = (row) => {
          const d = normalize(getDept(row));
          if (!d) return settings.treatAllLaborAsBanquet;
          return d.includes('banquet') || d.includes('bqt') || d.includes('event') || d.includes('catering');
        };

        // Load persistent data when modal opens
        useEffect(() => {
          (async () => {
            const [emps, evs, pls, setts] = await Promise.all([
              StorageAPI.get('employees') ,
              StorageAPI.get('banquet-events'),
              StorageAPI.get('schedule-plans'),
              StorageAPI.get('schedule-settings')
            ]);

            // Employees: seed from laborData if empty
            let seed = Array.isArray(emps) ? emps : [];
            if (seed.length === 0 && Array.isArray(laborData) && laborData.length) {
              const set = new Set();
              laborData.forEach(r => {
                const name = getEmployee(r);
                if (name) set.add(name);
              });
              seed = Array.from(set).sort().map(n => ({ name: n, role: 'Banquets', active: true }));
            }

            setEmployees(seed);

            setEvents(Array.isArray(evs) ? evs : []);
            setPlans(Array.isArray(pls) ? pls : []);
            if (setts && typeof setts === 'object') setSettings(prev => ({...prev, ...setts}));
          })();
        }, []);

        const saveEmployees = async (next) => {
          setEmployees(next);
          await StorageAPI.set('employees', next);
        };
        const saveEvents = async (next) => {
          setEvents(next);
          await StorageAPI.set('banquet-events', next);
        };
        const savePlans = async (next) => {
          setPlans(next);
          await StorageAPI.set('schedule-plans', next);
        };
        const saveSettings = async (next) => {
          setSettings(next);
          await StorageAPI.set('schedule-settings', next);
        };

        const totalSales = (() => {
          let t = 0;
          (salesData || []).forEach(r => {
            const revenue = num(
              r.revenue ?? r.Revenue ?? r.sales ?? r.Sales ?? r.total ?? r.Total ??
              r.netSales ?? r.NetSales ?? r.net_sales ?? r['Net Sales'] ?? r['Total Sales'] ??
              r.amount ?? r.Amount ?? 0
            );
            t += revenue;
          });
          return t;
        })();

        const laborAll = (laborData || []);
        const laborBanquet = laborAll.filter(looksBanquet);
        const laborUsed = laborBanquet.length ? laborBanquet : laborAll;

        const totals = (() => {
          let cost = 0, hours = 0;
          laborUsed.forEach(r => {
            cost += getCost(r);
            hours += getHours(r);
          });
          const pct = totalSales > 0 ? ((cost / totalSales) * 100) : null;
          return { cost, hours, pct, entries: laborUsed.length };
        })();

        const fmtMoney = (n) => '$' + num(n).toFixed(2);

        // --- Scheduling helpers ---
        const parseDate = (s) => {
          if (!s) return null;
          // accept YYYY-MM-DD or MM/DD/YYYY
          const raw = String(s).trim();
          const iso = /^\d{4}-\d{2}-\d{2}/.test(raw) ? raw.slice(0,10) : null;
          if (iso) {
            const d = new Date(iso + "T00:00:00");
            return isNaN(d.getTime()) ? null : d;
          }
          const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
          if (m) {
            const mm = String(m[1]).padStart(2,'0');
            const dd = String(m[2]).padStart(2,'0');
            const yy = m[3].length===2 ? ('20'+m[3]) : m[3];
            const d = new Date(`${yy}-${mm}-${dd}T00:00:00`);
            return isNaN(d.getTime()) ? null : d;
          }
          const d = new Date(raw);
          return isNaN(d.getTime()) ? null : d;
        };

        const toISO = (d) => d.toISOString().slice(0,10);

        const weekdayKey = (d) => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];

        const historicalHoursByWeekday = (() => {
          const map = {Sun:[],Mon:[],Tue:[],Wed:[],Thu:[],Fri:[],Sat:[]};
          laborUsed.forEach(r => {
            const d = parseDate(getDate(r));
            if (!d) return;
            const h = getHours(r);
            if (h > 0) map[weekdayKey(d)].push(h);
          });
          const avg = {};
          Object.keys(map).forEach(k => {
            const arr = map[k];
            const s = arr.reduce((a,b)=>a+b,0);
            avg[k] = arr.length ? (s/arr.length) : 0;
          });
          return avg;
        })();

        const eventHoursForDate = (isoDate) => {
          const todays = events.filter(e => String(e.date || e.Date || '').slice(0,10) === isoDate);
          let hrs = 0;
          todays.forEach(e => {
            const explicit = num(e.laborHours ?? e.LaborHours ?? e.hours ?? e.Hours ?? 0);
            if (explicit > 0) {
              hrs += explicit;
              return;
            }
            const guests = num(e.guests ?? e.Guests ?? e.pax ?? e.Pax ?? e['Guest Count'] ?? 0);
            hrs += (settings.fixedSetupHours + settings.fixedCleanupHours + (guests * settings.hoursPerGuest));
          });
          return hrs;
        };

        const forecastHoursForDate = (d) => {
          const iso = toISO(d);
          const byEvents = eventHoursForDate(iso);
          const base = num(settings.baseHoursPerDay);
          const hist = historicalHoursByWeekday[weekdayKey(d)] || 0;
          // If there are events, events dominate; otherwise baseline or weekday historical (whichever is larger)
          const noEventForecast = Math.max(base, hist);
          return Math.max(byEvents, noEventForecast);
        };

        const generatePlan = async () => {
          const horizon = Math.max(1, Math.min(28, Math.round(num(settings.horizonDays) || 14)));
          const shiftLen = Math.max(1, num(settings.shiftLengthHours) || 8);
          const maxWeekly = Math.max(1, num(settings.maxWeeklyHours) || 40);

          const today = new Date();
          const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const days = [];
          for (let i=0;i<horizon;i++){
            const d = new Date(start);
            d.setDate(start.getDate() + i);
            const iso = toISO(d);
            const hoursNeeded = forecastHoursForDate(d);
            days.push({ date: iso, hoursNeeded: Math.round(hoursNeeded*10)/10 });
          }

          // Build active employee list (banquet focus)
          const active = employees.filter(e => e && e.active !== false).map(e => e.name).filter(Boolean);
          if (active.length === 0){
            alert("Add at least 1 employee in Settings (Employees) to generate a schedule.");
            return;
          }

          // Weekly tracking (simple rolling 7-day bucket starting today)
          const assignedWeekly = {};
          active.forEach(n => assignedWeekly[n]=0);

          const planDays = days.map(day => {
            let needed = day.hoursNeeded;
            const shifts = Math.ceil(needed / shiftLen);
            const assignments = [];

            // Choose employees with the lowest assigned hours so far (fairness)
            const pickOrder = [...active].sort((a,b) => assignedWeekly[a]-assignedWeekly[b]);

            for (let s=0;s<shifts;s++){
              // re-sort each time to keep it fair
              pickOrder.sort((a,b) => assignedWeekly[a]-assignedWeekly[b]);
              const emp = pickOrder[0];
              const remaining = Math.max(0, needed);
              const hrs = Math.min(shiftLen, remaining);

              // allow overtime, but flag it
              const would = assignedWeekly[emp] + hrs;
              const overtime = would > maxWeekly;

              assignments.push({ employee: emp, hours: hrs, overtime });
              assignedWeekly[emp] = would;
              needed -= hrs;
            }

            return { ...day, shifts, assignments };
          });

          const plan = {
            id: Date.now(),
            createdAt: new Date().toISOString(),
            horizonDays: horizon,
            settings: { ...settings },
            summary: {
              totalHours: Math.round(planDays.reduce((a,b)=>a+b.hoursNeeded,0)*10)/10,
              totalShifts: planDays.reduce((a,b)=>a+b.shifts,0)
            },
            days: planDays
          };

          const next = [plan, ...(plans || [])].slice(0, 50);
          await savePlans(next);
          setTab('history');
        };

        const addEmployeeQuick = async () => {
          const name = prompt("Employee name?");
          if (!name) return;
          const next = [...employees, { name: name.trim(), role: 'Banquets', active: true }];
          await saveEmployees(next);
        };

        const addEventQuick = async () => {
          const date = prompt("Event date (YYYY-MM-DD)?");
          if (!date) return;
          const guests = prompt("Guest count?");
          const title = prompt("Event name?");
          const next = [
            { id: Date.now(), date: String(date).trim().slice(0,10), guests: num(guests), name: (title||'').trim() },
            ...(events || [])
          ];
          await saveEvents(next);
        };

        const importEventsCSV = (file) => {
          if (!file) return;
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (res) => {
              const rows = (res.data || []).filter(r => r && Object.keys(r).length);
              const mapped = rows.map((r, i) => ({
                id: Date.now() + i,
                date: String(r.date ?? r.Date ?? r['Event Date'] ?? r['Date'] ?? '').trim().slice(0,10),
                guests: num(r.guests ?? r.Guests ?? r.pax ?? r.Pax ?? r['Guest Count'] ?? 0),
                laborHours: num(r.laborHours ?? r['Labor Hours'] ?? r.hours ?? r['Hours'] ?? 0),
                name: String(r.name ?? r.Name ?? r.event ?? r.Event ?? r['Event Name'] ?? '').trim(),
                notes: String(r.notes ?? r.Notes ?? '').trim()
              })).filter(x => x.date);
              const next = [...mapped, ...(events || [])].slice(0, 300);
              await saveEvents(next);
              alert(`Imported ${mapped.length} events.`);
            }
          });
        };

        const Overview = () => (
          <div>
            <div style={{display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:'12px', marginBottom:'16px'}}>
              <div className="stat-card" style={{'--accent-color':'#10b981'}}>
                <div className="stat-header">
                  <div className="stat-label">Labor Cost</div>
                </div>
                <div className="stat-value">{fmtMoney(totals.cost)}</div>
                <div className="stat-change positive">
                  {totals.entries ? `${totals.entries} time entries` : 'Upload labor data'}
                </div>
              </div>

              <div className="stat-card" style={{'--accent-color':'#3b82f6'}}>
                <div className="stat-header">
                  <div className="stat-label">Labor Hours</div>
                </div>
                <div className="stat-value">{Math.round(totals.hours*10)/10}</div>
                <div className="stat-change positive">Banquets-focused when possible</div>
              </div>

              <div className="stat-card" style={{'--accent-color':'#f59e0b'}}>
                <div className="stat-header">
                  <div className="stat-label">Labor % of Sales</div>
                </div>
                <div className="stat-value">{totals.pct === null ? '-' : totals.pct.toFixed(2)+'%'}</div>
                <div className="stat-change negative">
                  {totalSales > 0 ? `Sales: ${fmtMoney(totalSales)}` : 'Upload sales to calculate %'}
                </div>
              </div>
            </div>

            <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
              <h3 style={{margin:'0 0 8px'}}>Banquet volatility helper</h3>
              <div style={{color:'var(--text-secondary)'}}>
                Upload or add upcoming events, then click <strong>Generate Schedule</strong> in the Scheduling tab. The app forecasts banquet labor hours per day using:
                <ul style={{margin:'8px 0 0 18px'}}>
                  <li><strong>Events:</strong> fixed setup + cleanup + (guests × hours/guest)</li>
                  <li><strong>No events:</strong> uses baseline hours/day or historical weekday average (whichever is higher)</li>
                </ul>
              </div>
            </div>
          </div>
        );

        const Scheduling = () => {
          const horizon = Math.max(1, Math.min(28, Math.round(num(settings.horizonDays) || 14)));
          const today = new Date();
          const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const rows = [];
          for (let i=0;i<horizon;i++){
            const d = new Date(start);
            d.setDate(start.getDate()+i);
            rows.push({
              date: toISO(d),
              weekday: weekdayKey(d),
              eventsHours: Math.round(eventHoursForDate(toISO(d))*10)/10,
              forecastHours: Math.round(forecastHoursForDate(d)*10)/10,
              staffNeeded: Math.ceil(forecastHoursForDate(d) / Math.max(1, num(settings.shiftLengthHours)||8))
            });
          }

          return (
            <div>
              <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'12px'}}>
                <button className="btn btn-primary" onClick={generatePlan}>Generate Schedule (next {horizon} days)</button>
                <button className="btn btn-secondary" onClick={addEventQuick}>+ Add Event</button>
                <label className="btn btn-secondary" style={{cursor:'pointer'}}>
                  Import Events CSV
                  <input type="file" accept=".csv" style={{display:'none'}} onChange={(e)=>importEventsCSV(e.target.files?.[0])}/>
                </label>
              </div>

              <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
                <h3 style={{margin:'0 0 10px'}}>Forecast (banquets)</h3>
                <div style={{maxHeight:'360px', overflow:'auto'}}>
                  <table className="table" style={{width:'100%'}}>
                    <thead>
                      <tr>
                        <th style={{textAlign:'left'}}>Date</th>
                        <th style={{textAlign:'left'}}>Day</th>
                        <th style={{textAlign:'right'}}>Event Hrs</th>
                        <th style={{textAlign:'right'}}>Forecast Hrs</th>
                        <th style={{textAlign:'right'}}>Staff (8h)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {rows.map((r, idx) => (
                        <tr key={idx}>
                          <td>{r.date}</td>
                          <td>{r.weekday}</td>
                          <td style={{textAlign:'right'}}>{r.eventsHours || '-'}</td>
                          <td style={{textAlign:'right'}}>{r.forecastHours}</td>
                          <td style={{textAlign:'right'}}>{r.staffNeeded}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px', marginTop:'12px'}}>
                <h3 style={{margin:'0 0 10px'}}>Upcoming Events</h3>
                {events.length === 0 ? (
                  <div style={{color:'var(--text-secondary)'}}>No events added yet. Add events or import a CSV.</div>
                ) : (
                  <div style={{maxHeight:'220px', overflow:'auto'}}>
                    <table className="table" style={{width:'100%'}}>
                      <thead>
                        <tr>
                          <th style={{textAlign:'left'}}>Date</th>
                          <th style={{textAlign:'left'}}>Event</th>
                          <th style={{textAlign:'right'}}>Guests</th>
                          <th style={{textAlign:'right'}}>Labor Hrs</th>
                        </tr>
                      </thead>
                      <tbody>
                        {events.slice(0, 80).map((e, idx) => (
                          <tr key={e.id || idx}>
                            <td>{String(e.date || '').slice(0,10)}</td>
                            <td>{e.name || '-'}</td>
                            <td style={{textAlign:'right'}}>{num(e.guests) || '-'}</td>
                            <td style={{textAlign:'right'}}>{num(e.laborHours) ? (Math.round(num(e.laborHours)*10)/10) : '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          );
        };

        const History = () => (
          <div>
            <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'12px'}}>
              <button className="btn btn-secondary" onClick={() => { if(confirm('Delete all saved schedules?')) savePlans([]); }}>Clear History</button>
            </div>

            {plans.length === 0 ? (
              <div style={{color:'var(--text-secondary)'}}>No saved schedules yet. Go to Scheduling → Generate Schedule.</div>
            ) : (
              <div style={{maxHeight:'420px', overflow:'auto'}}>
                <table className="table" style={{width:'100%'}}>
                  <thead>
                    <tr>
                      <th style={{textAlign:'left'}}>Created</th>
                      <th style={{textAlign:'right'}}>Days</th>
                      <th style={{textAlign:'right'}}>Total Hours</th>
                      <th style={{textAlign:'right'}}>Shifts</th>
                    </tr>
                  </thead>
                  <tbody>
                    {plans.slice(0, 25).map((p, idx) => (
                      <tr key={p.id || idx} onClick={() => alert(JSON.stringify(p, null, 2))} style={{cursor:'pointer'}}>
                        <td>{String(p.createdAt || '').replace('T',' ').slice(0,16)}</td>
                        <td style={{textAlign:'right'}}>{p.horizonDays}</td>
                        <td style={{textAlign:'right'}}>{p.summary?.totalHours ?? '-'}</td>
                        <td style={{textAlign:'right'}}>{p.summary?.totalShifts ?? '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div style={{color:'var(--text-secondary)', marginTop:'8px'}}>
                  Tip: click a schedule row to view the raw plan (prototype). Next step we can render it as a clean roster view.
                </div>
              </div>
            )}
          </div>
        );

        const Settings = () => (
          <div>
            <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px', marginBottom:'12px'}}>
              <h3 style={{margin:'0 0 10px'}}>Scheduling Settings</h3>
              <div style={{display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:'10px'}}>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Shift length (hours)</span>
                  <input value={settings.shiftLengthHours} onChange={(e)=>saveSettings({...settings, shiftLengthHours: num(e.target.value)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Max weekly hours</span>
                  <input value={settings.maxWeeklyHours} onChange={(e)=>saveSettings({...settings, maxWeeklyHours: num(e.target.value)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Horizon days</span>
                  <input value={settings.horizonDays} onChange={(e)=>saveSettings({...settings, horizonDays: num(e.target.value)})}/>
                </label>

                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Base hours/day</span>
                  <input value={settings.baseHoursPerDay} onChange={(e)=>saveSettings({...settings, baseHoursPerDay: num(e.target.value)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Hours per guest</span>
                  <input value={settings.hoursPerGuest} onChange={(e)=>saveSettings({...settings, hoursPerGuest: num(e.target.value)})}/>
                </label>
                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Fixed setup hours</span>
                  <input value={settings.fixedSetupHours} onChange={(e)=>saveSettings({...settings, fixedSetupHours: num(e.target.value)})}/>
                </label>

                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Fixed cleanup hours</span>
                  <input value={settings.fixedCleanupHours} onChange={(e)=>saveSettings({...settings, fixedCleanupHours: num(e.target.value)})}/>
                </label>

                <label style={{display:'flex', flexDirection:'column', gap:'6px'}}>
                  <span style={{color:'var(--text-secondary)'}}>Treat all labor as Banquets (if dept missing)</span>
                  <select value={settings.treatAllLaborAsBanquet ? 'yes' : 'no'} onChange={(e)=>saveSettings({...settings, treatAllLaborAsBanquet: e.target.value==='yes'})}>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                  </select>
                </label>
              </div>
            </div>

            <div className="card" style={{background:'var(--bg-secondary)', padding:'14px', borderRadius:'12px'}}>
              <h3 style={{margin:'0 0 10px'}}>Employees (banquets team)</h3>
              <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'10px'}}>
                <button className="btn btn-secondary" onClick={addEmployeeQuick}>+ Add Employee</button>
                <button className="btn btn-secondary" onClick={async ()=>{ 
                  // Re-seed from laborData
                  const set = new Set();
                  (laborData||[]).forEach(r => { const n = getEmployee(r); if (n) set.add(n); });
                  const seeded = Array.from(set).sort().map(n => ({ name:n, role:'Banquets', active:true }));
                  await saveEmployees(seeded);
                }}>Seed from Labor Data</button>
              </div>

              {employees.length === 0 ? (
                <div style={{color:'var(--text-secondary)'}}>No employees yet. Add employees or seed from labor data.</div>
              ) : (
                <div style={{maxHeight:'260px', overflow:'auto'}}>
                  <table className="table" style={{width:'100%'}}>
                    <thead>
                      <tr>
                        <th style={{textAlign:'left'}}>Employee</th>
                        <th style={{textAlign:'left'}}>Role</th>
                        <th style={{textAlign:'right'}}>Active</th>
                      </tr>
                    </thead>
                    <tbody>
                      {employees.map((e, idx) => (
                        <tr key={idx}>
                          <td>{e.name}</td>
                          <td>{e.role || 'Banquets'}</td>
                          <td style={{textAlign:'right'}}>
                            <select value={e.active === false ? 'no' : 'yes'} onChange={async (ev)=>{
                              const next = employees.map((x,i)=> i===idx ? {...x, active: ev.target.value==='yes'} : x);
                              await saveEmployees(next);
                            }}>
                              <option value="yes">Yes</option>
                              <option value="no">No</option>
                            </select>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        );

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Labor & Scheduling</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div style={{display:'flex', gap:'10px', flexWrap:'wrap', marginBottom:'14px'}}>
                <button className={`btn ${tab==='overview' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setTab('overview')}>Overview</button>
                <button className={`btn ${tab==='scheduling' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setTab('scheduling')}>Scheduling</button>
                <button className={`btn ${tab==='history' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setTab('history')}>History</button>
                <button className={`btn ${tab==='settings' ? 'btn-primary' : 'btn-secondary'}`} onClick={()=>setTab('settings')}>Settings</button>
              </div>

              {tab === 'overview' && <Overview />}
              {tab === 'scheduling' && <Scheduling />}
              {tab === 'history' && <History />}
              {tab === 'settings' && <Settings />}

              <div style={{display:'flex', justifyContent:'flex-end', gap:'10px', marginTop:'16px'}}>
                <button className="btn btn-secondary" onClick={() => setModalOpen(null)}>Close</button>
              </div>
            </div>
          </div>
        );
      };


      // --- NEW: Food Cost drill-down (Dashboard -> Food Cost) ---
      const FoodCostModal = () => {
        const num = (v) => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return isFinite(v) ? v : 0;
          const s0 = String(v).trim();
          if (!s0) return 0;
          // strip $, commas, and handle (123.45) negative format
          let s = s0.replace(/\$/g, '').replace(/,/g, '');
          const paren = /^\((.*)\)$/.exec(s);
          if (paren) s = '-' + paren[1];
          const m = s.match(/-?\d+(\.\d+)?/);
          if (!m) return 0;
          const n = parseFloat(m[0]);
          return isFinite(n) ? n : 0;
        };

        const getRevenue = (row) => {
          // common revenue field names
          return num(
            row.revenue ?? row.Revenue ?? row.sales ?? row.Sales ?? row.total ?? row.Total ??
            row.netSales ?? row.NetSales ?? row.net_sales ?? row.NET_SALES ??
            row['Net Sales'] ?? row['NET SALES'] ?? row['Total Sales'] ?? row['TOTAL SALES'] ??
            row.amount ?? row.Amount ?? 0
          );
        };

        const getCost = (row) => {
          // common cost/COGS field names (often missing in POS exports)
          return num(
            row.cost ?? row.Cost ?? row.cogs ?? row.COGS ?? row.foodCost ?? row.FoodCost ??
            row['Food Cost'] ?? row['FOOD COST'] ?? row['Item Cost'] ?? row['ITEM COST'] ??
            row['Cost of Goods'] ?? row['COST OF GOODS'] ?? 0
          );
        };

        const getDate = (row) => {
          return (
            row.date ?? row.Date ?? row.day ?? row.Day ?? row['Business Date'] ?? row['BUSINESS DATE'] ??
            row['Order Date'] ?? row['ORDER DATE'] ?? row['Date'] ?? ''
          );
        };

        let totalRevenue = 0;
        let totalCost = 0;
        let revenueRows = 0;
        let costRows = 0;

        (salesData || []).forEach(r => {
          const rev = getRevenue(r);
          const c = getCost(r);
          if (rev) revenueRows++;
          if (c) costRows++;
          totalRevenue += rev;
          totalCost += c;
        });

        const pct = totalRevenue > 0 ? (totalCost / totalRevenue) * 100 : 0;

        const fmtMoney = (n) => {
          try { return n.toLocaleString(undefined, { style: 'currency', currency: 'USD' }); }
          catch { return '$' + (Math.round(n * 100) / 100).toFixed(2); }
        };

        return (
          <div className="modal-overlay" onClick={() => setModalOpen(null)}>
            <div className="modal" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2 className="modal-title">Food Cost Details</h2>
                <button className="close-btn" onClick={() => setModalOpen(null)}>×</button>
              </div>

              <div style={{display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:'12px', marginBottom:'16px'}}>
                <div className="stat-card" style={{'--accent-color':'#3b82f6'}}>
                  <div className="stat-header">
                    <div className="stat-label">Total Sales (Revenue)</div>
                  </div>
                  <div className="stat-value">{fmtMoney(totalRevenue)}</div>
                  <div className="stat-change positive">{(salesData || []).length} records</div>
                </div>

                <div className="stat-card" style={{'--accent-color':'#10b981'}}>
                  <div className="stat-header">
                    <div className="stat-label">Total Cost (From Data)</div>
                  </div>
                  <div className="stat-value">{fmtMoney(totalCost)}</div>
                  <div className="stat-change positive">{costRows > 0 ? `${costRows} rows had cost` : 'No cost column found'}</div>
                </div>

                <div className="stat-card" style={{'--accent-color':'#ff4757'}}>
                  <div className="stat-header">
                    <div className="stat-label">Food Cost %</div>
                  </div>
                  <div className="stat-value">{totalRevenue > 0 ? pct.toFixed(1) + '%' : '-'}</div>
                  <div className="stat-change negative">
                    Formula: Cost ÷ Sales × 100
                  </div>
                </div>
              </div>

              {totalRevenue > 0 && totalCost === 0 && (
                <div className="alert" style={{marginBottom:'16px'}}>
                  <div className="alert-content">
                    <div className="alert-title">Heads up: your sales file has revenue but no cost</div>
                    <div className="alert-message">
                      Most POS exports don’t include item cost/COGS. To get real Food Cost %, upload a report that includes a cost column,
                      or we’ll add Purchases + Inventory Snapshot math next.
                    </div>
                  </div>
                </div>
              )}

              <div style={{marginBottom:'10px', color:'var(--text-secondary)'}}>
                <strong>What this is showing:</strong> We sum the revenue and cost from your uploaded sales data (if cost exists).
              </div>

              <div className="table-container" style={{maxHeight:'50vh', overflow:'auto'}}>
                <table className="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th style={{textAlign:'right'}}>Revenue</th>
                      <th style={{textAlign:'right'}}>Cost</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(salesData || []).slice(0, 100).map((r, i) => {
                      const rev = getRevenue(r);
                      const c = getCost(r);
                      return (
                        <tr key={i}>
                          <td>{String(getDate(r) || '').slice(0, 30)}</td>
                          <td style={{textAlign:'right'}}>{rev ? fmtMoney(rev) : '-'}</td>
                          <td style={{textAlign:'right'}}>{c ? fmtMoney(c) : '-'}</td>
                        </tr>
                      );
                    })}
                    {(salesData || []).length > 100 && (
                      <tr>
                        <td colSpan="3" style={{color:'var(--text-secondary)'}}>
                          Showing first 100 rows. (We can add paging later.)
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              <div style={{display:'flex', justifyContent:'flex-end', gap:'10px', marginTop:'18px'}}>
                <button className="btn btn-secondary" onClick={() => setModalOpen(null)}>Close</button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="app-container">
          <header className="header">
            <div className="logo-section">
              <div className="logo">🔥</div>
              <div className="header-info">
                <h1>Chef Ops AI</h1>
                <p>{restaurantInfo.name} • {restaurantInfo.location}</p>
              </div>
            </div>
            <div className="header-actions">
              <button className="btn btn-secondary" onClick={() => setModalOpen('upload')}>
                📤 Upload Data
              </button>
              <button className="btn btn-primary" onClick={() => {
                console.log('Current Stats:', stats);
                console.log('Sales Data:', salesData);
                console.log('Waste Data:', wasteData);
                console.log('Labor Data:', laborData);
              }}>
                🔍 Debug Stats
              </button>
            </div>
          </header>

          <div className="tabs">
            <button 
              className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
              onClick={() => setActiveTab('dashboard')}
            >
              Dashboard
            </button>
            <button 
              className={`tab ${activeTab === 'inventory' ? 'active' : ''}`}
              onClick={() => setActiveTab('inventory')}
            >
              Inventory
            </button>
            <button 
              className={`tab ${activeTab === 'recipes' ? 'active' : ''}`}
              onClick={() => setActiveTab('recipes')}
            >
              Recipes
            </button>
            <button 
              className={`tab ${activeTab === 'orders' ? 'active' : ''}`}
              onClick={() => setActiveTab('orders')}
            >
              Orders
            </button>
            <button 
              className={`tab ${activeTab === 'banquets' ? 'active' : ''}`}
              onClick={() => setActiveTab('banquets')}
            >
              Banquets
            </button>
            <button 
              className={`tab ${activeTab === 'analytics' ? 'active' : ''}`}
              onClick={() => setActiveTab('analytics')}
            >
              Analytics
            </button>
          </div>

          {activeTab === 'dashboard' && <Dashboard />}
          {activeTab === 'inventory' && <Inventory focus={inventoryFocus} clearFocus={() => setInventoryFocus(null)} />}
          {activeTab === 'recipes' && <Recipes />}
          {activeTab === 'orders' && <Orders />}
          {activeTab === 'banquets' && <Banquets />}
          {activeTab === 'analytics' && <Analytics />}

          {/* Modals */}
          {modalOpen === 'add-item' && <AddItemModal />}
          {modalOpen === 'smart-order' && <SmartOrderModal />}
          {modalOpen === 'upload' && <UploadModal />}
          {modalOpen === 'food-cost' && <FoodCostModal />}
          {modalOpen === 'waste' && <WasteModal />}
          {modalOpen === 'labor' && <LaborModal />}
          {modalOpen === 'order-guide' && <OrderGuideModal />}
          {modalOpen?.type === 'edit-beo' && <EditBEOModal event={modalOpen.event} />}
          {modalOpen?.type === 'view-order-guide' && <ViewOrderGuideModal guide={modalOpen.guide} />}
          {modalOpen === 'add-recipe' && <AddRecipeModal />}
          {modalOpen?.type === 'edit-item' && <EditItemModal item={modalOpen.item} />}
          {modalOpen?.type === 'view-recipe' && <ViewRecipeModal recipe={modalOpen.recipe} />}

          {/* Toast */}
          {toast && (
            <Toast 
              message={toast.message} 
              type={toast.type} 
              onClose={() => setToast(null)} 
            />
          )}
        </div>
      );
    };

    ReactDOM.render(<ChefOpsAI />, document.getElementById('root'));
  </script>
</body>
</html>